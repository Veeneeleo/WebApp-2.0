<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DVS Crates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; background:#eee; }
    .good{ background:#d6ffe0; } .warn{ background:#fff2c9; } .bad{ background:#ffd6d6; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; gap:10px; justify-content:space-between; align-items:flex-start; padding:10px 0; border-bottom:1px solid #eee; }
    button,input,select { padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    button:disabled { opacity:0.5; }
    input[type="text"], input[type="password"] { width:min(520px,100%); }
    small { opacity:0.7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .muted { opacity: 0.75; }
    .btnRow { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:12px; }
    .danger { border-color:#f3b3b3; }
    .hint { margin-top:6px; }
    progress { width:100%; height:18px; }
    .tiny { font-size: 11px; }
    .split { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .w520 { width:min(520px,100%); }
  </style>
</head>
<body>
  <header>
    <h1>DVS Crates</h1>
    <div id="vinylPill" class="pill">VINYL: unknown</div>
  </header>

  <div class="grid">
    <section class="card">
      <h2>1) Connect to Raspberry Pi (BLE)</h2>

      <div class="row">
        <div>
          <b>Bluetooth</b><br/>
          <small>iOS: Bluefy + HTTPS required.</small>
        </div>
        <div class="btnRow">
          <button id="bleConnectBtn">Connect</button>
          <button id="bleDisconnectBtn" disabled>Disconnect</button>
        </div>
      </div>

      <div class="row">
        <div>
          <b>Connection mode</b><br/>
          <small>If your Pi doesn’t show in the picker, switch to Name mode.</small>
        </div>
        <div class="btnRow">
          <select id="bleMode">
            <option value="uuid" selected>Filter by UART UUID</option>
            <option value="name">Filter by Name Prefix (DVS)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <b>Status</b><br/>
          <small>Polls STATUS from Pi → updates VINYL pill.</small>
        </div>
        <div class="btnRow">
          <button id="statusBtn" disabled>STATUS</button>
          <button id="startPollBtn" disabled>Start Poll</button>
          <button id="stopPollBtn" disabled>Stop Poll</button>
        </div>
      </div>

      <div class="mono" id="bleLog" style="white-space:pre-wrap; max-height:260px; overflow:auto;"></div>
      <div class="muted"><small id="env"></small></div>
    </section>

    <section class="card">
      <h2>2) Wi-Fi on Pi (via BLE)</h2>

      <div class="row">
        <div>
          <b>Scan + Join</b><br/>
          <small>Only needed for SpotDL downloads. Turn Wi-Fi off during play if you want.</small>
        </div>
        <div class="btnRow">
          <button id="wifiScanBtn" disabled>Scan</button>
          <button id="wifiStatusBtn" disabled>Status</button>
          <button id="wifiOffBtn" disabled>Wi-Fi Off</button>
        </div>
      </div>

      <div class="row" style="border-bottom:none;">
        <div style="width:100%;">
          <div class="muted hint"><small>Networks:</small></div>
          <select id="wifiSsid" class="w520" disabled>
            <option value="">(scan first)</option>
          </select>

          <div class="hint"></div>
          <input id="wifiPass" type="password" class="w520" placeholder="Wi-Fi password (blank if open)" disabled />

          <div class="btnRow" style="margin-top:10px;">
            <button id="wifiJoinBtn" disabled>Join</button>
          </div>

          <div class="muted hint">
            <small>
              State: <span id="wifiState">unknown</span>
              &nbsp; | &nbsp; IP: <span id="wifiIp">-</span>
            </small>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="grid">
    <section class="card">
      <h2>3) Spotify Login + Search</h2>

      <div class="row">
        <div>
          <b>Spotify</b><br/>
          <small>Auto-search while typing. Tracks &gt; 10 min are disabled.</small>
        </div>
        <div class="btnRow">
          <button id="spotifyLoginBtn">Login</button>
          <button id="spotifyLogoutBtn">Logout</button>
        </div>
      </div>

      <div id="me" class="muted"></div>

      <div class="row" style="border-bottom:none;">
        <div style="width:100%;">
          <input id="searchBox" type="text" placeholder="Type to search tracks…" class="w520" />
          <div class="muted hint"><small id="searchHint"></small></div>
          <div class="muted hint">
            <small><b>Crate cap:</b> total ≤ 10:00. Current crate: <span id="crateDurLabel">0:00</span></small>
          </div>
        </div>
      </div>

      <div id="results"></div>
    </section>

    <section class="card">
      <h2>4) Download progress (SpotDL on Pi)</h2>

      <div class="row" id="dlRow" style="display:none; border-bottom:none;">
        <div style="width:100%;">
          <b>Downloading on Pi…</b> <span class="chip" id="dlPct">0%</span><br/>
          <progress id="dlProg" value="0" max="100"></progress>
          <div class="muted"><small id="dlMsg"></small></div>
        </div>
      </div>

      <div class="muted tiny">
        <small>
          From Pi notifications: DL_MSG / DL_PCT / DL_DONE / DL_ERR.
        </small>
      </div>
    </section>
  </div>

  <section class="card">
    <h2>5) Current Playlist (Crate)</h2>

    <div class="row">
      <div>
        <b>Selected tracks</b> <span class="chip" id="selectedCount">0</span><br/>
        <small>Crate duration must stay ≤ 10:00 total.</small>
      </div>
      <div class="btnRow">
        <button id="clearSelectedBtn">Clear</button>
      </div>
    </div>

    <ol id="selected"></ol>

    <div class="row" style="border-bottom:none;">
      <input id="crateName" type="text" placeholder="Crate name (e.g., My Set 1)" class="w520" />
      <div class="btnRow">
        <button id="saveCrateBtn">Save Crate</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>6) Saved Crates</h2>

    <div class="row">
      <div>
        <b>Your crates</b><br/>
        <small>Stored in localStorage on your phone.</small>
      </div>
      <div class="btnRow">
        <button id="refreshCratesBtn">Refresh</button>
      </div>
    </div>

    <ul id="crates"></ul>
  </section>

<script>
/* ======================== CHANGE ME (Spotify) ======================== */
const SPOTIFY_CLIENT_ID = "81cff1fc219b442abfb47d9a3bba8960";   // <- your Spotify Client ID
const REDIRECT_URI = "https://veeneeleo.github.io/WebApp-2.0/";        // <- set EXACT redirect (include trailing slash if used)
const SCOPES = ["user-read-email"];
const CRATE_MAX_MS = 10 * 60 * 1000;     // <= 10 minutes TOTAL
/* ================================================================ */

/* ======================== BLE Nordic UART UUIDs ======================== */
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write
const UART_TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify
/* ================================================================ */

const $ = (id) => document.getElementById(id);

function logBle(msg) { $("bleLog").textContent = msg + "\n" + $("bleLog").textContent; }
function setVinylPill({ ready, lock }) {
  const pill = $("vinylPill");
  if (ready) { pill.className="pill good"; pill.textContent="VINYL: READY"; }
  else if (lock) { pill.className="pill warn"; pill.textContent="VINYL: LOCKED"; }
  else { pill.className="pill bad"; pill.textContent="VINYL: NO LOCK"; }
}

const enc = (s)=> new TextEncoder().encode(s);
const dec = (u8)=> new TextDecoder().decode(u8);

/* ======================== Download UI ======================== */
function showDlUI(show){ $("dlRow").style.display = show ? "" : "none"; }
function setDlProgress(pct, msg){
  pct = Math.max(0, Math.min(100, (pct|0)));
  $("dlProg").value = pct;
  $("dlPct").textContent = pct + "%";
  $("dlMsg").textContent = msg || "";
}
/* ================================================================ */

/* ======================== Local crate storage ======================== */
const LS_KEY = "dvs_crates_v5";
function loadCrates(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch { return []; } }
function saveCrates(crates){ localStorage.setItem(LS_KEY, JSON.stringify(crates)); }
/* ================================================================ */

/* ======================== BLE ======================== */
let ble = {
  device:null,
  server:null,
  svc:null,
  rx:null,
  tx:null,
  connected:false,
  notifyBuf:"",
  pollTimer:null,
  lastStatus:{ready:false, lock:false, posMs:0, rate:1.0},
};

function setBleUi(connected){
  $("bleConnectBtn").disabled = connected;
  $("bleDisconnectBtn").disabled = !connected;
  $("statusBtn").disabled = !connected;
  $("startPollBtn").disabled = !connected;
  $("stopPollBtn").disabled = !connected;

  $("wifiScanBtn").disabled = !connected;
  $("wifiStatusBtn").disabled = !connected;
  $("wifiOffBtn").disabled = !connected;
  $("wifiSsid").disabled = !connected;
  $("wifiPass").disabled = !connected;
  $("wifiJoinBtn").disabled = !connected;
}

function safeAlertBleError(e){
  console.error("BLE error:", e);
  const name = e?.name || "n/a";
  const msg = e?.message || String(e);
  const code = (e?.code ?? "n/a");
  alert(`BLE error:\nname=${name}\nmessage=${msg}\ncode=${code}`);
}

function onBleText(text){
  ble.notifyBuf += text;
  let idx;
  while((idx = ble.notifyBuf.indexOf("\n")) >= 0){
    const line = ble.notifyBuf.slice(0, idx).trim();
    ble.notifyBuf = ble.notifyBuf.slice(idx + 1);
    if(!line) continue;

    // dvs_core STATUS parsing
    if (line.startsWith("READY ")) ble.lastStatus.ready = line.endsWith("1");
    else if (line.startsWith("LOCK ")) ble.lastStatus.lock = line.endsWith("1");
    else if (line.startsWith("POS_MS ")) ble.lastStatus.posMs = parseInt(line.slice(7), 10) || 0;
    else if (line.startsWith("RATE ")) ble.lastStatus.rate = parseFloat(line.slice(5)) || 0;
    else if (line === ".") setVinylPill({ ready: ble.lastStatus.ready, lock: ble.lastStatus.lock });

    // SpotDL progress parsing
    else if (line.startsWith("DL_PCT ")) {
      showDlUI(true);
      setDlProgress(parseInt(line.slice(7),10)||0, $("dlMsg").textContent);
    } else if (line.startsWith("DL_MSG ")) {
      showDlUI(true);
      setDlProgress(parseInt($("dlProg").value,10)||0, line.slice(7));
    } else if (line === "DL_DONE") {
      setDlProgress(100, "Done.");
      setTimeout(()=>showDlUI(false), 1500);
    } else if (line.startsWith("DL_ERR ")) {
      showDlUI(true);
      setDlProgress(parseInt($("dlProg").value,10)||0, "Error: " + line.slice(7));
      alert("Download failed: " + line.slice(7));
    }

    // Wi-Fi parsing
    else if (line.startsWith("WIFI_NET ")) {
      const payload = line.slice(9);
      const [ssid, sig] = payload.split("|");
      const signal = parseInt(sig||"0",10)||0;
      if(ssid && ssid.trim()){
        const s = ssid.trim();
        const i = wifiNets.findIndex(x=>x.ssid===s);
        if(i>=0) wifiNets[i].signal = Math.max(wifiNets[i].signal, signal);
        else wifiNets.push({ssid:s, signal});
      }
    } else if (line === "WIFI_SCAN_DONE") {
      wifiNets.sort((a,b)=>b.signal-a.signal);
      wifiRenderNets();
      logBle("Wi-Fi scan done.");
    } else if (line.startsWith("WIFI_STATE ")) {
      wifiSetState(line.slice(11).trim(), $("wifiIp").textContent === "-" ? "" : $("wifiIp").textContent);
    } else if (line.startsWith("WIFI_IP ")) {
      wifiSetState($("wifiState").textContent, line.slice(8).trim());
    } else if (line.startsWith("WIFI_ERR ")) {
      alert("Wi-Fi error: " + line.slice(9));
    }

    logBle(line);
  }
}

async function bleWriteLine(line){
  if(!ble.connected || !ble.rx) throw new Error("Not connected");
  if(!line.endsWith("\n")) line += "\n";
  const data = enc(line);

  // iOS reliability: prefer writeValue
  if (ble.rx.writeValue) await ble.rx.writeValue(data);
  else await ble.rx.writeValueWithoutResponse(data);
}

function stopPoll(){
  if(ble.pollTimer) clearInterval(ble.pollTimer);
  ble.pollTimer = null;
}

async function statusOnce(){ await bleWriteLine("STATUS"); }

function startPoll(){
  stopPoll();
  ble.pollTimer = setInterval(()=>{
    if(ble.connected) bleWriteLine("STATUS").catch(()=>{});
  }, 300);
  logBle("Polling STATUS…");
}

function cleanupBleState(){
  stopPoll();
  ble.connected = false;
  ble.server = null;
  ble.svc = null;
  ble.rx = null;
  ble.tx = null;
  setBleUi(false);
  refreshCrates();
}

async function bleConnect(){
  if(!window.isSecureContext) throw new Error("Must be HTTPS");
  if(!navigator.bluetooth) throw new Error("WebBluetooth not available");

  // prevent double-click / overlapping connects
  $("bleConnectBtn").disabled = true;

  try{
    logBle("Requesting device…");

    const mode = $("bleMode").value;

    if(mode === "name"){
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "DVS" }],
        optionalServices: [UART_SERVICE_UUID],
      });
    } else {
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [UART_SERVICE_UUID] }],
        optionalServices: [UART_SERVICE_UUID],
      });
    }

    ble.device.addEventListener("gattserverdisconnected", ()=>{
      logBle("GATT disconnected.");
      cleanupBleState();
    });

    logBle("Connecting GATT…");
    ble.server = await ble.device.gatt.connect();

    logBle("Getting UART service…");
    ble.svc = await ble.server.getPrimaryService(UART_SERVICE_UUID);

    logBle("Getting characteristics…");
    ble.rx = await ble.svc.getCharacteristic(UART_RX_UUID);
    ble.tx = await ble.svc.getCharacteristic(UART_TX_UUID);

    logBle("Enabling notifications…");
    await ble.tx.startNotifications();

    ble.tx.addEventListener("characteristicvaluechanged", (ev)=>{
      const v = ev.target.value;
      const bytes = new Uint8Array(v.buffer);
      onBleText(dec(bytes));
    });

    // NOW we are truly connected
    ble.connected = true;
    setBleUi(true);
    refreshCrates();
    logBle("BLE connected ✅");
  } finally {
    // enable connect button only if still disconnected
    $("bleConnectBtn").disabled = ble.connected;
  }
}

async function bleDisconnect(){
  try{
    stopPoll();
    if(ble.device?.gatt?.connected) ble.device.gatt.disconnect();
  } catch {}
  cleanupBleState();
  logBle("BLE disconnected.");
}
/* ================================================================ */

/* ======================== Wi-Fi UI ======================== */
let wifiNets = [];
function wifiRenderNets(){
  const sel = $("wifiSsid");
  sel.innerHTML = "";
  if(!wifiNets.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(no networks — tap Scan)";
    sel.appendChild(opt);
    return;
  }
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "(choose a network)";
  sel.appendChild(opt0);
  wifiNets.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n.ssid;
    opt.textContent = `${n.ssid} (${n.signal}%)`;
    sel.appendChild(opt);
  });
}
function wifiSetState(state, ip=""){
  $("wifiState").textContent = state || "unknown";
  $("wifiIp").textContent = ip || "-";
}
async function wifiScan(){
  if(!ble.connected) return alert("Connect BLE first.");
  wifiNets = [];
  wifiRenderNets();
  wifiSetState("scanning","");
  await bleWriteLine("WIFI_SCAN");
}
async function wifiJoin(){
  if(!ble.connected) return alert("Connect BLE first.");
  const ssid = $("wifiSsid").value;
  const pwd = $("wifiPass").value;
  if(!ssid) return alert("Choose a network first.");
  wifiSetState("connecting","");
  await bleWriteLine(`WIFI_JOIN ${ssid}|${pwd}`);
}
async function wifiStatus(){
  if(!ble.connected) return alert("Connect BLE first.");
  await bleWriteLine("WIFI_STATUS");
}
async function wifiOff(){
  if(!ble.connected) return alert("Connect BLE first.");
  await bleWriteLine("WIFI_OFF");
}
/* ================================================================ */

/* ======================== Spotify PKCE ======================== */
function base64urlencode(a) {
  return btoa(String.fromCharCode(...new Uint8Array(a)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}
async function sha256(plain) {
  return crypto.subtle.digest("SHA-256", new TextEncoder().encode(plain));
}
function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let s = "";
  for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}
function spotifyToken(){ return localStorage.getItem("spotify_token"); }

async function spotifyLogin(){
  if (SPOTIFY_CLIENT_ID === "CHANGE_ME" || !SPOTIFY_CLIENT_ID.trim()) {
    alert("Set SPOTIFY_CLIENT_ID first.");
    return;
  }
  if (REDIRECT_URI === "CHANGE_ME" || !REDIRECT_URI.trim()) {
    alert("Set REDIRECT_URI first (must match Spotify dashboard exactly).");
    return;
  }

  const verifier = randomString(96);
  const challenge = base64urlencode(await sha256(verifier));
  // sessionStorage tends to behave better on iOS for PKCE flows
  sessionStorage.setItem("pkce_verifier", verifier);

  const args = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID,
    response_type: "code",
    redirect_uri: REDIRECT_URI,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: SCOPES.join(" "),
  });

  location.href = `https://accounts.spotify.com/authorize?${args.toString()}`;
}

async function exchangeCodeForToken(code){
  const verifier = sessionStorage.getItem("pkce_verifier");
  const body = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID,
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier,
  });

  const r = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  });

  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  localStorage.setItem("spotify_token", data.access_token);
  // Remove code from URL so it can't be reused
  history.replaceState({}, document.title, REDIRECT_URI);
  return data.access_token;
}

function spotifyLogout(){
  localStorage.removeItem("spotify_token");
  sessionStorage.removeItem("pkce_verifier");
  $("me").textContent = "";
  clearResults();
  $("searchHint").textContent = "";
  alert("Logged out.");
}

async function spotifyGET(path){
  const token = spotifyToken();
  if (!token) throw new Error("Not logged in");
  const r = await fetch(`https://api.spotify.com/v1${path}`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}

async function loadMe(){
  const me = await spotifyGET("/me");
  $("me").textContent = `Logged in as: ${me.display_name || me.id}`;
}
/* ================================================================ */

/* ======================== Auto search + crate cap ======================== */
const selected = [];
let lastSearchItems = [];
let searchTimer = null;
let lastQuery = "";
let blurHideTimer = null;

function fmtDur(ms){
  const s = Math.round(ms/1000);
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2,'0')}`;
}
function crateTotalMs(){ return selected.reduce((a,t)=>a+(t.duration_ms||0),0); }
function updateCrateDurLabel(){ $("crateDurLabel").textContent = fmtDur(crateTotalMs()); }
function isAlreadySelected(id){ return selected.some(t=>t.id===id); }
function canAddTrack(t){
  if(!t) return false;
  if(t.duration_ms > CRATE_MAX_MS) return false;
  return (crateTotalMs()+t.duration_ms) <= CRATE_MAX_MS;
}

function renderSelected(){
  $("selectedCount").textContent = String(selected.length);
  updateCrateDurLabel();
  const ol = $("selected");
  ol.innerHTML = "";
  selected.forEach((t, idx)=>{
    const li = document.createElement("li");
    li.className = "row";
    li.style.borderBottom = "1px solid #eee";
    li.innerHTML = `
      <div style="max-width:70%;">
        <b>${t.name}</b> — ${t.artist}<br/>
        <small>${fmtDur(t.duration_ms)}</small>
      </div>
      <div class="btnRow">
        <button data-act="up">↑</button>
        <button data-act="down">↓</button>
        <button class="danger" data-act="remove">Remove</button>
      </div>
    `;
    li.querySelector('[data-act="up"]').onclick = ()=>{
      if(idx===0) return;
      [selected[idx-1], selected[idx]] = [selected[idx], selected[idx-1]];
      renderSelected(); renderResults(lastSearchItems);
    };
    li.querySelector('[data-act="down"]').onclick = ()=>{
      if(idx===selected.length-1) return;
      [selected[idx+1], selected[idx]] = [selected[idx], selected[idx+1]];
      renderSelected(); renderResults(lastSearchItems);
    };
    li.querySelector('[data-act="remove"]').onclick = ()=>{
      selected.splice(idx,1);
      renderSelected(); renderResults(lastSearchItems);
    };
    ol.appendChild(li);
  });
}

function clearResults(){ lastSearchItems=[]; $("results").innerHTML=""; }

function renderResults(items){
  lastSearchItems = items || [];
  const root = $("results");
  root.innerHTML = "";
  if(!items || !items.length) return;

  const total = crateTotalMs();

  items.forEach((t)=>{
    const tooLong = t.duration_ms > CRATE_MAX_MS;
    const already = isAlreadySelected(t.id);
    const wouldExceed = !already && (total + t.duration_ms > CRATE_MAX_MS);

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="max-width:70%;">
        <b>${t.name}</b> — ${t.artist}<br/>
        <small>${fmtDur(t.duration_ms)}
          ${tooLong ? "(too long)" : ""}
          ${wouldExceed ? "(crate full)" : ""}
        </small>
      </div>
      <div class="btnRow">
        <button ${tooLong||already||wouldExceed ? "disabled":""}>
          ${already ? "Added" : (wouldExceed ? "Full" : "Add")}
        </button>
      </div>
    `;
    row.querySelector("button").onclick = ()=>{
      if(tooLong || already) return;
      if(!canAddTrack(t)){
        alert("Crate limit is 10:00 total.");
        return;
      }
      selected.push(t);
      renderSelected();
      renderResults(items);
    };
    root.appendChild(row);
  });
}

async function doSearchAuto(q){
  if(!spotifyToken()){
    $("searchHint").textContent = "Login to Spotify to search.";
    clearResults();
    return;
  }
  q = q.trim();
  if(q.length < 2){
    $("searchHint").textContent = "Type at least 2 characters.";
    clearResults();
    return;
  }
  if(q === lastQuery) return;
  lastQuery = q;

  $("searchHint").textContent = "Searching…";
  try{
    const data = await spotifyGET(`/search?type=track&limit=20&q=${encodeURIComponent(q)}`);
    const items = data.tracks.items.map(tr=>({
      id: tr.id,
      uri: tr.uri,
      name: tr.name,
      artist: tr.artists?.[0]?.name ?? "Unknown",
      duration_ms: tr.duration_ms,
    }));
    $("searchHint").textContent = `Results for: "${q}" (tap outside to hide)`;
    renderResults(items);
  } catch(e){
    $("searchHint").textContent = "Search failed (check login).";
    console.error(e);
  }
}

function onSearchInput(){
  const q = $("searchBox").value;
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>doSearchAuto(q), 250);
}
function onSearchBlur(){
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = setTimeout(()=>{
    clearResults();
    $("searchHint").textContent = "";
  }, 200);
}
function onSearchFocus(){
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = null;
  if(spotifyToken()) $("searchHint").textContent = "Type to search (results auto-hide when you tap outside).";
}

function saveCrate(){
  const name = $("crateName").value.trim();
  if(!name) return alert("Enter a crate name.");
  if(!selected.length) return alert("Add some tracks first.");

  const total = crateTotalMs();
  if(total > CRATE_MAX_MS) return alert("Crate total exceeds 10:00.");

  const crates = loadCrates();
  crates.unshift({
    id: crypto.randomUUID(),
    name,
    tracks: [...selected],
    total_ms: total,
    createdAt: Date.now(),
  });
  saveCrates(crates);

  selected.length = 0;
  renderSelected();
  $("crateName").value = "";
  refreshCrates();
  alert("Crate saved.");
}

function refreshCrates(){
  const crates = loadCrates();
  const ul = $("crates");
  ul.innerHTML = "";

  crates.forEach((c)=>{
    const li = document.createElement("li");
    li.className = "row";
    li.innerHTML = `
      <div style="max-width:70%;">
        <b>${c.name}</b>
        <span class="chip">${c.tracks.length} tracks</span>
        <span class="chip">${fmtDur(c.total_ms || 0)}</span><br/>
        <small>${new Date(c.createdAt).toLocaleString()}</small>
      </div>
      <div class="btnRow">
        <button data-act="send" ${ble.connected ? "" : "disabled"}>Send + Download</button>
        <button data-act="load">Load</button>
        <button class="danger" data-act="del">Delete</button>
      </div>
    `;

    li.querySelector('[data-act="send"]').onclick = async ()=>{
      if(!ble.connected) return alert("Connect BLE first.");

      showDlUI(true);
      setDlProgress(0, "Sending crate to Pi…");

      const safe = (s)=>String(s||"").replace(/\|/g," ").replace(/\n/g," ").trim();

      await bleWriteLine(`CRATE_BEGIN ${safe(c.name)}`);
      await bleWriteLine(`CRATE_TOTAL_MS ${c.total_ms || 0}`);
      for(const t of c.tracks){
        await bleWriteLine(`CRATE_TRACK ${safe(t.id)}|${t.duration_ms||0}|${safe(t.uri)}|${safe(t.name)}|${safe(t.artist)}`);
      }
      await bleWriteLine("CRATE_END");

      setDlProgress(0, "Starting SpotDL on Pi…");
      await bleWriteLine(`DL_START ${safe(c.name)}`);
    };

    li.querySelector('[data-act="load"]').onclick = ()=>{
      selected.length = 0;
      c.tracks.forEach(t=>selected.push(t));
      renderSelected();
      $("crateName").value = c.name;
      alert("Crate loaded.");
    };

    li.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm(`Delete crate "${c.name}"?`)) return;
      saveCrates(crates.filter(x=>x.id!==c.id));
      refreshCrates();
    };

    ul.appendChild(li);
  });
}
/* ================================================================ */

/* ======================== Wire UI ======================== */
$("bleConnectBtn").onclick = async ()=>{
  try { await bleConnect(); }
  catch(e){ safeAlertBleError(e); cleanupBleState(); $("bleConnectBtn").disabled = false; }
};

$("bleDisconnectBtn").onclick = ()=> bleDisconnect();

$("statusBtn").onclick = ()=> statusOnce().catch(e=> safeAlertBleError(e));
$("startPollBtn").onclick = ()=> startPoll();
$("stopPollBtn").onclick = ()=> stopPoll();

$("wifiScanBtn").onclick = ()=> wifiScan().catch(e=> safeAlertBleError(e));
$("wifiJoinBtn").onclick = ()=> wifiJoin().catch(e=> safeAlertBleError(e));
$("wifiStatusBtn").onclick = ()=> wifiStatus().catch(e=> safeAlertBleError(e));
$("wifiOffBtn").onclick = ()=> wifiOff().catch(e=> safeAlertBleError(e));

$("spotifyLoginBtn").onclick = ()=> spotifyLogin().catch(e=> alert("Spotify login error: "+(e?.message||e)));
$("spotifyLogoutBtn").onclick = ()=> spotifyLogout();

$("searchBox").addEventListener("input", onSearchInput);
$("searchBox").addEventListener("blur", onSearchBlur);
$("searchBox").addEventListener("focus", onSearchFocus);

$("saveCrateBtn").onclick = ()=> saveCrate();
$("refreshCratesBtn").onclick = ()=> refreshCrates();
$("clearSelectedBtn").onclick = ()=>{
  selected.length = 0;
  renderSelected();
  renderResults(lastSearchItems);
};
/* ================================================================ */

/* ======================== Boot ======================== */
setBleUi(false);
wifiRenderNets();
renderSelected();
refreshCrates();

(function boot(){
  $("env").textContent =
    `secureContext=${window.isSecureContext} | navigator.bluetooth=${!!navigator.bluetooth} | url=${location.href}`;

  const url = new URL(location.href);
  const code = url.searchParams.get("code");

  // prevent “authorization code expired” loops
  const usedCode = sessionStorage.getItem("spotify_used_code");
  if(code && usedCode === code){
    history.replaceState({}, document.title, REDIRECT_URI !== "CHANGE_ME" ? REDIRECT_URI : (location.origin + location.pathname));
  }

  (async ()=>{
    if(code && usedCode !== code){
      sessionStorage.setItem("spotify_used_code", code);
      try { await exchangeCodeForToken(code); }
      catch(e){
        sessionStorage.removeItem("spotify_used_code");
        sessionStorage.removeItem("pkce_verifier");
        alert("Spotify token exchange failed. Check Redirect URI + Client ID.\n" + (e?.message || e));
      }
    }

    if(spotifyToken()){
      try { await loadMe(); } catch {}
      $("searchHint").textContent = "Type to search (results auto-hide when you tap outside).";
    } else {
      $("searchHint").textContent = "Login to Spotify to search.";
    }
  })();
})();
</script>
</body>
</html>
