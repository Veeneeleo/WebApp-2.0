<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
<<<<<<< HEAD
  <title>BurnVinyl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --cream: #f8f5f0;
      --warm-white: #faf8f5;
      --charcoal: #2a2522;
      --deep-brown: #3d3330;
      --burgundy: #8b2635;
      --deep-red: #a23545;
      --warm-red: #c14554;
      --gold: #d4a574;
      --light-gold: #e6c9a0;
      --border-subtle: #e0d5c7;
      --text-primary: #2a2522;
      --text-secondary: #6b5d54;
      --text-muted: #9a8a7d;
    }

    body {
      font-family: 'Crimson Text', serif;
      background: var(--cream);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    /* Subtle texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(42, 37, 34, 0.02) 2px, rgba(42, 37, 34, 0.02) 4px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.3;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 100%;
      padding: 0;
    }

    /* Header */
    header {
      background: linear-gradient(180deg, var(--warm-white) 0%, var(--cream) 100%);
      padding: 32px 24px 24px;
      border-bottom: 3px solid var(--burgundy);
      box-shadow: 0 2px 12px rgba(139, 38, 53, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 42px;
      font-weight: 900;
      letter-spacing: -1px;
      color: var(--burgundy);
      margin-bottom: 8px;
      text-align: center;
    }

    .tagline {
      font-family: 'Crimson Text', serif;
      font-size: 16px;
      font-style: italic;
      color: var(--text-secondary);
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* Cards */
    .card {
      background: var(--warm-white);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      margin: 24px 16px;
      padding: 28px 24px;
      box-shadow: 
        0 1px 3px rgba(42, 37, 34, 0.06),
        0 4px 12px rgba(42, 37, 34, 0.04);
      animation: cardSlideIn 0.6s ease-out;
      position: relative;
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--burgundy), var(--deep-red), var(--warm-red));
    }

    .card h2 {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--burgundy);
      margin-bottom: 20px;
      letter-spacing: -0.5px;
    }

    /* Buttons */
    button {
      font-family: 'Crimson Text', serif;
      padding: 14px 24px;
      border: none;
      border-radius: 2px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: var(--burgundy);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(139, 38, 53, 0.25);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(139, 38, 53, 0.2);
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:active {
      background: var(--border-subtle);
      transform: translateY(1px);
    }

    .btn-success {
      background: var(--deep-brown);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(61, 51, 48, 0.25);
    }

    .btn-danger {
      background: var(--warm-red);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(193, 69, 84, 0.25);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .btn-row button {
      flex: 1;
      min-width: 120px;
    }

    /* Input fields */
    input, select {
      font-family: 'Crimson Text', serif;
      width: 100%;
      padding: 14px 16px;
      background: var(--cream);
      border: 2px solid var(--border-subtle);
      border-radius: 2px;
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--burgundy);
      box-shadow: 0 0 0 3px rgba(139, 38, 53, 0.1);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    /* Search */
    .search-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      margin-top: 6px;
    }

    input[type="text"] {
      padding-left: 48px;
    }

    .search-hint {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 12px;
      min-height: 20px;
      font-style: italic;
    }

    /* Results */
    .results-list {
      margin-top: 16px;
    }

    .track-item {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-left: 4px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      animation: trackSlideIn 0.4s ease-out;
    }

    @keyframes trackSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .track-item:active {
      transform: scale(0.98);
      background: var(--border-subtle);
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .track-meta {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .track-item button {
      flex-shrink: 0;
      min-width: 90px;
      padding: 10px 18px;
    }

    .duration-badge {
      display: inline-block;
      padding: 3px 10px;
      background: var(--warm-white);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      font-size: 13px;
      color: var(--burgundy);
      font-weight: 600;
    }

    .warning-badge {
      color: var(--warm-red);
      border-color: var(--warm-red);
    }

    /* Crate list */
    .crate-counter {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: var(--cream);
      border-radius: 2px;
      border: 1px solid var(--border-subtle);
    }

    .counter-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
    }

    .counter-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--burgundy);
      font-family: 'Playfair Display', serif;
    }

    .selected-tracks {
      list-style: none;
      margin: 20px 0;
    }

    .selected-tracks li {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-left: 4px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px;
      margin-bottom: 14px;
      animation: trackSlideIn 0.4s ease-out;
    }

    .track-controls {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .track-controls button {
      flex: 1;
      padding: 10px 14px;
      font-size: 14px;
    }

    /* Log */
    .log-container {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      padding: 14px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 16px;
      font-family: 'Crimson Text', serif;
      line-height: 1.8;
    }

    .log-container::-webkit-scrollbar {
      width: 8px;
    }

    .log-container::-webkit-scrollbar-track {
      background: var(--warm-white);
    }

    .log-container::-webkit-scrollbar-thumb {
      background: var(--border-subtle);
      border-radius: 4px;
    }

    /* Collapsible sections */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 10px 0;
    }

    .collapsible-header::after {
      content: '‚ñº';
      font-size: 14px;
      color: var(--text-muted);
      transition: transform 0.3s ease;
    }

    .collapsible-header.collapsed::after {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    /* Saved crates */
    .crate-list {
      list-style: none;
    }

    .crate-list-item {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      padding: 20px;
      margin-bottom: 16px;
      animation: trackSlideIn 0.4s ease-out;
    }

    .crate-header {
      margin-bottom: 16px;
    }

    .crate-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-family: 'Playfair Display', serif;
    }

    .crate-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 600;
      background: var(--warm-white);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .badge-tracks {
      color: var(--burgundy);
      border-color: var(--burgundy);
    }

    .badge-duration {
      color: var(--deep-brown);
      border-color: var(--deep-brown);
    }

    .crate-date {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 10px;
      font-style: italic;
    }

    .crate-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .crate-actions button {
      flex: 1;
      font-size: 14px;
      padding: 12px 16px;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.4;
    }

    /* Utility classes */
    .hidden {
      display: none !important;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mb-16 {
      margin-bottom: 16px;
    }

    /* Link styling */
    a {
      color: var(--burgundy);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:active {
      color: var(--deep-red);
    }

    /* Section divider */
    .section-number {
      display: inline-block;
      width: 32px;
      height: 32px;
      background: var(--burgundy);
      border-radius: 50%;
      text-align: center;
      line-height: 32px;
      font-weight: 700;
      font-size: 16px;
      color: var(--warm-white);
      margin-right: 12px;
      font-family: 'Playfair Display', serif;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--warm-white);
      border: 2px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px 28px;
      box-shadow: 0 8px 32px rgba(42, 37, 34, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      border-color: var(--warm-red);
      color: var(--warm-red);
    }

    .toast.success {
      border-color: var(--deep-brown);
      color: var(--deep-brown);
    }

    /* Wi-Fi network list */
    .network-option {
      padding: 14px;
      background: var(--cream);
    }

    /* Fixed bottom progress bar */
    .progress-bar-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--warm-white);
      border-top: 2px solid var(--burgundy);
      padding: 16px 20px;
      box-shadow: 0 -4px 20px rgba(42, 37, 34, 0.1);
      z-index: 200;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-bar-fixed.visible {
      transform: translateY(0);
    }

    .download-status {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--burgundy);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--cream);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
      border: 1px solid var(--border-subtle);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--burgundy), var(--deep-red));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .download-message {
      font-size: 13px;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Better mobile spacing */
    @media (max-width: 768px) {
      .card {
        margin: 16px 12px;
        padding: 20px 16px;
      }

      h1 {
        font-size: 32px;
      }

      .btn-row button {
        min-width: 100px;
        font-size: 14px;
        padding: 12px 16px;
      }
    }

    /* Apple-style NFC Modal */
    .nfc-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .nfc-modal-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }

    .nfc-modal {
      background: var(--warm-white);
      border-radius: 16px;
      width: 90%;
      max-width: 340px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nfc-modal-overlay.visible .nfc-modal {
      transform: scale(1);
    }

    .nfc-modal-content {
      padding: 32px 24px;
      text-align: center;
    }

    .nfc-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, var(--burgundy), var(--deep-red));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      animation: nfcPulse 2s ease-in-out infinite;
    }

    @keyframes nfcPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(139, 38, 53, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 20px rgba(139, 38, 53, 0);
      }
    }

    .nfc-icon.scanning {
      animation: nfcScan 1.5s linear infinite;
    }

    @keyframes nfcScan {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }

    .nfc-icon.complete {
      background: linear-gradient(135deg, var(--deep-brown), #2a2522);
      animation: nfcComplete 0.5s ease-out;
    }

    @keyframes nfcComplete {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }

    .nfc-modal h3 {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .nfc-modal p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .nfc-modal-buttons {
      display: flex;
      gap: 12px;
    }

    .nfc-modal-buttons button {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="logoTitle" style="cursor: pointer; user-select: none;">BurnVinyl</h1>
    </header>

    <!-- Advanced Options (BLE/WiFi) - Modal Overlay -->
    <div id="advancedOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding-top: 60px; overflow-y: auto;">
      <div id="bleAdvancedContent" style="background: var(--warm-white); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 28px; width: 90%; max-width: 500px; box-shadow: 0 8px 32px rgba(42, 37, 34, 0.25); margin-bottom: 60px; position: relative;">
        <button id="closeAdvanced" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; padding: 4px 8px; line-height: 1;">√ó</button>
        
        <h3 style="font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--burgundy); margin-bottom: 20px;">Bluetooth & Wi-Fi</h3>
        
        <div class="btn-row" style="margin-bottom: 20px;">
          <button id="bleConnectBtn" class="btn-primary">Connect to Pi</button>
          <button id="bleDisconnectBtn" class="btn-danger" disabled>Disconnect</button>
        </div>

        <select id="bleMode">
          <option value="uuid" selected>Filter by UART UUID</option>
          <option value="name">Filter by Name (DVS)</option>
        </select>

        <div class="btn-row">
          <button id="statusBtn" class="btn-secondary" disabled>Check Status</button>
          <button id="startPollBtn" class="btn-secondary" disabled>Start Poll</button>
          <button id="stopPollBtn" class="btn-secondary" disabled>Stop Poll</button>
        </div>

        <div class="log-container" id="bleLog"></div>

        <!-- Wi-Fi Setup -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
          <h3 style="font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: var(--burgundy); margin-bottom: 16px;">Wi-Fi Setup</h3>
          
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; font-style: italic;">
            Connect your Pi to Wi-Fi for downloads. You can disable Wi-Fi during playback.
          </p>

          <div class="btn-row">
            <button id="wifiScanBtn" class="btn-secondary" disabled>Scan Networks</button>
            <button id="wifiStatusBtn" class="btn-secondary" disabled>Check Status</button>
            <button id="wifiOffBtn" class="btn-danger" disabled>Turn Off</button>
          </div>

          <select id="wifiSsid" disabled>
            <option value="">(scan for networks first)</option>
          </select>

          <input id="wifiPass" type="password" placeholder="Wi-Fi password (leave blank if open)" disabled />

          <div class="btn-row">
            <button id="wifiJoinBtn" class="btn-success" disabled>Connect to Network</button>
          </div>

          <div style="margin-top: 20px; padding: 16px; background: var(--cream); border-radius: 2px; font-size: 14px; border: 1px solid var(--border-subtle);">
            <div style="color: var(--text-secondary); margin-bottom: 6px;">
              Status: <span id="wifiState" style="color: var(--burgundy); font-weight: 600;">unknown</span>
            </div>
            <div style="color: var(--text-secondary);">
              IP: <span id="wifiIp" style="color: var(--burgundy); font-weight: 600;">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search -->
    <div class="card">
      <h2><span class="section-number">1</span> Search Music</h2>
      
      <div class="search-wrapper">
        <div class="search-icon">üîç</div>
        <input id="searchBox" type="text" placeholder="Search for tracks on YouTube..." />
      </div>
      <div class="search-hint" id="searchHint">Type to search tracks</div>

      <div class="crate-counter">
        <div>
          <div class="counter-label">Crate Limit</div>
          <div style="font-size: 14px; color: var(--text-muted); margin-top: 6px;">10:00 max</div>
=======
  <title>DVS Crates - YouTube Music</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; background:#eee; }
    .good{ background:#d6ffe0; } .warn{ background:#fff2c9; } .bad{ background:#ffd6d6; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; gap:10px; justify-content:space-between; align-items:flex-start; padding:10px 0; border-bottom:1px solid #eee; }
    button,input,select { padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    button:disabled { opacity:0.5; }
    input[type="text"], input[type="password"] { width:min(520px,100%); }
    small { opacity:0.7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .muted { opacity: 0.75; }
    .btnRow { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f3f3; font-size:12px; }
    .danger { border-color:#f3b3b3; }
    .hint { margin-top:6px; }
    progress { width:100%; height:18px; }
    .tiny { font-size: 11px; }
    .split { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .w520 { width:min(520px,100%); }
  </style>
</head>
<body>
  <header>
    <h1>DVS Crates - YouTube Music</h1>
    <div id="vinylPill" class="pill">VINYL: unknown</div>
  </header>

  <div class="grid">
    <section class="card">
      <h2>1) Connect to Raspberry Pi (BLE)</h2>

      <div class="row">
        <div>
          <b>Bluetooth</b><br/>
          <small>iOS: Bluefy + HTTPS required.</small>
>>>>>>> parent of 186e709 (Finished????)
        </div>
        <div class="btnRow">
          <button id="bleConnectBtn">Connect</button>
          <button id="bleDisconnectBtn" disabled>Disconnect</button>
        </div>
      </div>

<<<<<<< HEAD
      <div class="results-list" id="results"></div>
    </div>

    <!-- Current Crate -->
    <div class="card">
      <h2><span class="section-number">2</span> Current Playlist</h2>
      
      <div class="crate-counter">
=======
      <div class="row">
>>>>>>> parent of 186e709 (Finished????)
        <div>
          <b>Connection mode</b><br/>
          <small>If your Pi doesn't show in the picker, switch to Name mode.</small>
        </div>
<<<<<<< HEAD
        <div style="margin-left: auto;">
          <button id="clearSelectedBtn" class="btn-danger" style="padding: 10px 18px; font-size: 14px;">Clear All</button>
        </div>
      </div>

      <ol class="selected-tracks" id="selected"></ol>

      <input id="crateName" type="text" placeholder="Name your crate (e.g., Friday Night Set)" />
      

=======
        <div class="btnRow">
          <select id="bleMode">
            <option value="uuid" selected>Filter by UART UUID</option>
            <option value="name">Filter by Name Prefix (DVS)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <b>Status</b><br/>
          <small>Polls STATUS from Pi ‚Üí updates VINYL pill.</small>
        </div>
        <div class="btnRow">
          <button id="statusBtn" disabled>STATUS</button>
          <button id="startPollBtn" disabled>Start Poll</button>
          <button id="stopPollBtn" disabled>Stop Poll</button>
        </div>
      </div>
>>>>>>> parent of 186e709 (Finished????)

      <div class="mono" id="bleLog" style="white-space:pre-wrap; max-height:260px; overflow:auto;"></div>
      <div class="muted"><small id="env"></small></div>
    </section>

    <section class="card">
      <h2>2) Wi-Fi on Pi (via BLE)</h2>

      <div class="row">
        <div>
          <b>Scan + Join</b><br/>
          <small>Only needed for yt-dlp downloads. Turn Wi-Fi off during play if you want.</small>
        </div>
        <div class="btnRow">
          <button id="wifiScanBtn" disabled>Scan</button>
          <button id="wifiStatusBtn" disabled>Status</button>
          <button id="wifiOffBtn" disabled>Wi-Fi Off</button>
        </div>
      </div>

<<<<<<< HEAD
    <!-- Saved Crates -->
    <div class="card">
      <h2><span class="section-number">3</span> Your Crates</h2>
      
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; font-style: italic;">
        Saved locally on your device
      </p>

      <button id="refreshCratesBtn" class="btn-secondary" style="width: 100%; margin-bottom: 20px;">Refresh List</button>
=======
      <div class="row" style="border-bottom:none;">
        <div style="width:100%;">
          <div class="muted hint"><small>Networks:</small></div>
          <select id="wifiSsid" class="w520" disabled>
            <option value="">(scan first)</option>
          </select>

          <div class="hint"></div>
          <input id="wifiPass" type="password" class="w520" placeholder="Wi-Fi password (blank if open)" disabled />
>>>>>>> parent of 186e709 (Finished????)

          <div class="btnRow" style="margin-top:10px;">
            <button id="wifiJoinBtn" disabled>Join</button>
          </div>

          <div class="muted hint">
            <small>
              State: <span id="wifiState">unknown</span>
              &nbsp; | &nbsp; IP: <span id="wifiIp">-</span>
            </small>
          </div>
        </div>
      </div>
    </section>
  </div>

<<<<<<< HEAD
  <!-- NFC Modal -->
  <div class="nfc-modal-overlay" id="nfcModal">
    <div class="nfc-modal">
      <div class="nfc-modal-content">
        <div class="nfc-icon" id="nfcIcon">üì±</div>
        <h3 id="nfcTitle">Ready to Burn</h3>
        <p id="nfcMessage">Tap your vinyl record to begin burning the crate</p>
        <div class="nfc-modal-buttons">
          <button class="btn-secondary" id="nfcCancelBtn">Cancel</button>
          <button class="btn-primary" id="nfcScanBtn">Scan NFC</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>
=======
  <div class="grid">
    <section class="card">
      <h2>3) YouTube Music Login + Search</h2>

      <div class="row" style="border-bottom:none;">
        <div style="width:100%;">
          <input id="searchBox" type="text" placeholder="Type to search tracks‚Ä¶" class="w520" />
          <div class="muted hint"><small id="searchHint"></small></div>
          <div class="muted hint">
            <small><b>Crate cap:</b> total ‚â§ 10:00. Current crate: <span id="crateDurLabel">0:00</span></small>
          </div>
        </div>
      </div>

      <div id="results"></div>
    </section>

    <section class="card">
      <h2>4) Download progress (yt-dlp on Pi)</h2>

      <div class="row" id="dlRow" style="display:none; border-bottom:none;">
        <div style="width:100%;">
          <b>Downloading on Pi‚Ä¶</b> <span class="chip" id="dlPct">0%</span><br/>
          <progress id="dlProg" value="0" max="100"></progress>
          <div class="muted"><small id="dlMsg"></small></div>
        </div>
      </div>

      <div class="muted tiny">
        <small>
          From Pi notifications: DL_MSG / DL_PCT / DL_DONE / DL_ERR.
        </small>
      </div>
    </section>
  </div>

  <section class="card">
    <h2>5) Current Playlist (Crate)</h2>

    <div class="row">
      <div>
        <b>Selected tracks</b> <span class="chip" id="selectedCount">0</span><br/>
        <small>Crate duration must stay ‚â§ 10:00 total.</small>
      </div>
      <div class="btnRow">
        <button id="clearSelectedBtn">Clear</button>
      </div>
    </div>

    <ol id="selected"></ol>

    <div class="row" style="border-bottom:none;">
      <input id="crateName" type="text" placeholder="Crate name (e.g., My Set 1)" class="w520" />
      <div class="btnRow">
        <button id="saveCrateBtn">Save Crate</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>6) Saved Crates</h2>

    <div class="row">
      <div>
        <b>Your crates</b><br/>
        <small>Stored in localStorage on your phone.</small>
      </div>
      <div class="btnRow">
        <button id="refreshCratesBtn">Refresh</button>
      </div>
    </div>

    <ul id="crates"></ul>
  </section>
>>>>>>> parent of 186e709 (Finished????)

  <!-- Fixed bottom progress bar -->
  <div class="progress-bar-fixed" id="dlRow">
    <div class="download-status">
      <span>Downloading</span>
      <span id="dlPct" style="font-family: 'Playfair Display', serif;">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="dlProg" style="width: 0%"></div>
    </div>
  </div>

<script>
/* ======================== CHANGE ME (YouTube) ======================== */
const YOUTUBE_API_KEY = "AIzaSyAcahPuv_d4f1GS3PkA2HBVfE6TryHeeMM";  // <- your YouTube Data API v3 key
const CRATE_MAX_MS = 10 * 60 * 1000;     // <= 10 minutes TOTAL
/* ================================================================ */

/* ======================== BLE Nordic UART UUIDs ======================== */
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write
const UART_TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify
/* ================================================================ */

const $ = (id) => document.getElementById(id);

<<<<<<< HEAD
function logBle(msg) { 
  const log = $("bleLog");
  const entry = document.createElement('div');
  entry.textContent = msg;
  entry.style.animation = 'trackSlideIn 0.3s ease-out';
  log.insertBefore(entry, log.firstChild);
}

function showToast(msg, type = 'info') {
  const toast = $("toast");
  toast.textContent = msg;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

const enc = (s) => new TextEncoder().encode(s);
const dec = (u8) => new TextDecoder().decode(u8);

/* ======================== Download UI ======================== */
function showDlUI(show) {
  const dlRow = $("dlRow");
  if (show) {
    dlRow.classList.add('visible');
  } else {
    dlRow.classList.remove('visible');
  }
}

function setDlProgress(pct, msg) {
=======
function logBle(msg) { $("bleLog").textContent = msg + "\n" + $("bleLog").textContent; }
function setVinylPill({ ready, lock }) {
  const pill = $("vinylPill");
  if (ready) { pill.className="pill good"; pill.textContent="VINYL: READY"; }
  else if (lock) { pill.className="pill warn"; pill.textContent="VINYL: LOCKED"; }
  else { pill.className="pill bad"; pill.textContent="VINYL: NO LOCK"; }
}

const enc = (s)=> new TextEncoder().encode(s);
const dec = (u8)=> new TextDecoder().decode(u8);

/* ======================== Download UI ======================== */
function showDlUI(show){ $("dlRow").style.display = show ? "" : "none"; }
function setDlProgress(pct, msg){
>>>>>>> parent of 186e709 (Finished????)
  pct = Math.max(0, Math.min(100, (pct|0)));
  $("dlProg").value = pct;
  $("dlPct").textContent = pct + "%";
  $("dlMsg").textContent = msg || "";
}
/* ================================================================ */

/* ======================== Local crate storage ======================== */
const LS_KEY = "dvs_crates_youtube_v1";
function loadCrates(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch { return []; } }
function saveCrates(crates){ localStorage.setItem(LS_KEY, JSON.stringify(crates)); }
/* ================================================================ */

/* ======================== BLE ======================== */
let ble = {
  device:null,
  server:null,
  svc:null,
  rx:null,
  tx:null,
  connected:false,
  notifyBuf:"",
  pollTimer:null,
  lastStatus:{ready:false, lock:false, posMs:0, rate:1.0},
};

function setBleUi(connected){
  $("bleConnectBtn").disabled = connected;
  $("bleDisconnectBtn").disabled = !connected;
  $("statusBtn").disabled = !connected;
  $("startPollBtn").disabled = !connected;
  $("stopPollBtn").disabled = !connected;

  $("wifiScanBtn").disabled = !connected;
  $("wifiStatusBtn").disabled = !connected;
  $("wifiOffBtn").disabled = !connected;
  $("wifiSsid").disabled = !connected;
  $("wifiPass").disabled = !connected;
  $("wifiJoinBtn").disabled = !connected;
}

function safeAlertBleError(e){
  console.error("BLE error:", e);
  const name = e?.name || "n/a";
  const msg = e?.message || String(e);
  const code = (e?.code ?? "n/a");
  alert(`BLE error:\nname=${name}\nmessage=${msg}\ncode=${code}`);
}

function onBleText(text){
  ble.notifyBuf += text;
  let idx;
  while((idx = ble.notifyBuf.indexOf("\n")) >= 0){
    const line = ble.notifyBuf.slice(0, idx).trim();
    ble.notifyBuf = ble.notifyBuf.slice(idx + 1);
    if(!line) continue;

    // dvs_core STATUS parsing
    if (line.startsWith("READY ")) ble.lastStatus.ready = line.endsWith("1");
    else if (line.startsWith("LOCK ")) ble.lastStatus.lock = line.endsWith("1");
    else if (line.startsWith("POS_MS ")) ble.lastStatus.posMs = parseInt(line.slice(7), 10) || 0;
    else if (line.startsWith("RATE ")) ble.lastStatus.rate = parseFloat(line.slice(5)) || 0;

    // yt-dlp progress parsing
    else if (line.startsWith("DL_PCT ")) {
      showDlUI(true);
      setDlProgress(parseInt(line.slice(7),10)||0, $("dlMsg").textContent);
    } else if (line.startsWith("DL_MSG ")) {
      showDlUI(true);
      setDlProgress(parseInt($("dlProg").value,10)||0, line.slice(7));
    } else if (line === "DL_DONE") {
<<<<<<< HEAD
      setDlProgress(100, "Download complete!");
      showToast("Download complete!", 'success');
      setTimeout(()=>showDlUI(false), 3000);
=======
      setDlProgress(100, "Done.");
      setTimeout(()=>showDlUI(false), 1500);
>>>>>>> parent of 186e709 (Finished????)
    } else if (line.startsWith("DL_ERR ")) {
      showDlUI(true);
      setDlProgress(parseInt($("dlProg").value,10)||0, "Error: " + line.slice(7));
      alert("Download failed: " + line.slice(7));
    }

    // Wi-Fi parsing
    else if (line.startsWith("WIFI_NET ")) {
      const payload = line.slice(9);
      const [ssid, sig] = payload.split("|");
      const signal = parseInt(sig||"0",10)||0;
      if(ssid && ssid.trim()){
        const s = ssid.trim();
        const i = wifiNets.findIndex(x=>x.ssid===s);
        if(i>=0) wifiNets[i].signal = Math.max(wifiNets[i].signal, signal);
        else wifiNets.push({ssid:s, signal});
      }
    } else if (line === "WIFI_SCAN_DONE") {
      wifiNets.sort((a,b)=>b.signal-a.signal);
      wifiRenderNets();
      logBle("Wi-Fi scan done.");
    } else if (line.startsWith("WIFI_STATE ")) {
      wifiSetState(line.slice(11).trim(), $("wifiIp").textContent === "-" ? "" : $("wifiIp").textContent);
    } else if (line.startsWith("WIFI_IP ")) {
      wifiSetState($("wifiState").textContent, line.slice(8).trim());
    } else if (line.startsWith("WIFI_ERR ")) {
      alert("Wi-Fi error: " + line.slice(9));
    }

    logBle(line);
  }
}

async function bleWriteLine(line){
  if(!ble.connected || !ble.rx) throw new Error("Not connected");
  if(!line.endsWith("\n")) line += "\n";
  const data = enc(line);

  // iOS reliability: prefer writeValue
  if (ble.rx.writeValue) await ble.rx.writeValue(data);
  else await ble.rx.writeValueWithoutResponse(data);
}

function stopPoll(){
  if(ble.pollTimer) clearInterval(ble.pollTimer);
  ble.pollTimer = null;
}

async function statusOnce(){ await bleWriteLine("STATUS"); }

function startPoll(){
  stopPoll();
  ble.pollTimer = setInterval(()=>{
    if(ble.connected) bleWriteLine("STATUS").catch(()=>{});
  }, 300);
  logBle("Polling STATUS‚Ä¶");
}

function cleanupBleState(){
  stopPoll();
  ble.connected = false;
  ble.server = null;
  ble.svc = null;
  ble.rx = null;
  ble.tx = null;
  setBleUi(false);
  refreshCrates();
}

async function bleConnect(){
  if(!window.isSecureContext) throw new Error("Must be HTTPS");
  if(!navigator.bluetooth) throw new Error("WebBluetooth not available");

  // prevent double-click / overlapping connects
  $("bleConnectBtn").disabled = true;

  try{
    logBle("Requesting device‚Ä¶");

    const mode = $("bleMode").value;

    if(mode === "name"){
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "DVS" }],
        optionalServices: [UART_SERVICE_UUID],
      });
    } else {
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [UART_SERVICE_UUID] }],
        optionalServices: [UART_SERVICE_UUID],
      });
    }

    ble.device.addEventListener("gattserverdisconnected", ()=>{
      logBle("GATT disconnected.");
      cleanupBleState();
    });

    logBle("Connecting GATT‚Ä¶");
    ble.server = await ble.device.gatt.connect();

    logBle("Getting UART service‚Ä¶");
    ble.svc = await ble.server.getPrimaryService(UART_SERVICE_UUID);

    logBle("Getting characteristics‚Ä¶");
    ble.rx = await ble.svc.getCharacteristic(UART_RX_UUID);
    ble.tx = await ble.svc.getCharacteristic(UART_TX_UUID);

    logBle("Enabling notifications‚Ä¶");
    await ble.tx.startNotifications();

    ble.tx.addEventListener("characteristicvaluechanged", (ev)=>{
      const v = ev.target.value;
      const bytes = new Uint8Array(v.buffer);
      onBleText(dec(bytes));
    });

    // NOW we are truly connected
    ble.connected = true;
    setBleUi(true);
    refreshCrates();
    logBle("BLE connected ‚úÖ");
  } finally {
    // enable connect button only if still disconnected
    $("bleConnectBtn").disabled = ble.connected;
  }
}

async function bleDisconnect(){
  try{
    stopPoll();
    if(ble.device?.gatt?.connected) ble.device.gatt.disconnect();
  } catch {}
  cleanupBleState();
  logBle("BLE disconnected.");
}
/* ================================================================ */

/* ======================== Wi-Fi UI ======================== */
let wifiNets = [];
function wifiRenderNets(){
  const sel = $("wifiSsid");
  sel.innerHTML = "";
  if(!wifiNets.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(no networks ‚Äî tap Scan)";
    sel.appendChild(opt);
    return;
  }
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "(choose a network)";
  sel.appendChild(opt0);
  wifiNets.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n.ssid;
    opt.textContent = `${n.ssid} (${n.signal}%)`;
    sel.appendChild(opt);
  });
}
function wifiSetState(state, ip=""){
  $("wifiState").textContent = state || "unknown";
  $("wifiIp").textContent = ip || "-";
}
async function wifiScan(){
  if(!ble.connected) return alert("Connect BLE first.");
  wifiNets = [];
  wifiRenderNets();
  wifiSetState("scanning","");
  await bleWriteLine("WIFI_SCAN");
}
async function wifiJoin(){
  if(!ble.connected) return alert("Connect BLE first.");
  const ssid = $("wifiSsid").value;
  const pwd = $("wifiPass").value;
  if(!ssid) return alert("Choose a network first.");
  wifiSetState("connecting","");
  await bleWriteLine(`WIFI_JOIN ${ssid}|${pwd}`);
}
async function wifiStatus(){
  if(!ble.connected) return alert("Connect BLE first.");
  await bleWriteLine("WIFI_STATUS");
}
async function wifiOff(){
  if(!ble.connected) return alert("Connect BLE first.");
  await bleWriteLine("WIFI_OFF");
}
/* ================================================================ */

/* ======================== YouTube API (No Auth Required) ======================== */
async function youtubeSearch(query){
  if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY.includes("YOUR_")) {
    throw new Error("Set YOUTUBE_API_KEY first");
  }
  
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&videoCategoryId=10&q=${encodeURIComponent(query + " music")}&key=${YOUTUBE_API_KEY}`;
  
  const r = await fetch(url);
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}

async function youtubeGetVideoDetails(videoIds){
  const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
  
  const r = await fetch(url);
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}
/* ================================================================ */

<<<<<<< HEAD
/* ======================== NFC Modal ======================== */
function showNfcModal() {
  const modal = $("nfcModal");
  const icon = $("nfcIcon");
  const title = $("nfcTitle");
  const message = $("nfcMessage");
  const scanBtn = $("nfcScanBtn");
  
  // Reset to initial state
  icon.className = "nfc-icon";
  icon.textContent = "üì±";
  title.textContent = "Ready to Burn";
  message.textContent = "Tap your vinyl record to begin burning the crate";
  scanBtn.style.display = "";
  
  modal.classList.add('visible');
}

function hideNfcModal() {
  const modal = $("nfcModal");
  modal.classList.remove('visible');
}

async function scanNfc() {
  const icon = $("nfcIcon");
  const title = $("nfcTitle");
  const message = $("nfcMessage");
  const scanBtn = $("nfcScanBtn");
  const cancelBtn = $("nfcCancelBtn");
  
  // Change to scanning state
  icon.className = "nfc-icon scanning";
  icon.textContent = "üì°";
  title.textContent = "Scanning...";
  message.textContent = "Hold your vinyl record near the device";
  scanBtn.disabled = true;
  cancelBtn.disabled = true;
  
  // Wait 3 seconds
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // Change to complete state
  icon.className = "nfc-icon complete";
  icon.textContent = "‚úì";
  title.textContent = "Complete!";
  message.textContent = "Vinyl tag detected. Starting burn process...";
  
  // Wait a moment to show success
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Hide modal
  hideNfcModal();
  
  // Reset button states
  scanBtn.disabled = false;
  cancelBtn.disabled = false;
}
/* ================================================================ */

/* ======================== Search & Crate ======================== */
=======
/* ======================== Auto search + crate cap ======================== */
>>>>>>> parent of 186e709 (Finished????)
const selected = [];
let lastSearchItems = [];
let searchTimer = null;
let lastQuery = "";
let blurHideTimer = null;

function fmtDur(ms){
  const s = Math.round(ms/1000);
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2,'0')}`;
}

function parseDuration(duration) {
  // Parse ISO 8601 duration format (PT#M#S or PT#H#M#S)
  const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  if (!match) return 0;
  
  const hours = parseInt(match[1] || 0);
  const minutes = parseInt(match[2] || 0);
  const seconds = parseInt(match[3] || 0);
  
  return (hours * 3600 + minutes * 60 + seconds) * 1000;
}

function crateTotalMs(){ return selected.reduce((a,t)=>a+(t.duration_ms||0),0); }
function updateCrateDurLabel(){ $("crateDurLabel").textContent = fmtDur(crateTotalMs()); }
function isAlreadySelected(id){ return selected.some(t=>t.id===id); }
function canAddTrack(t){
  if(!t) return false;
  if(t.duration_ms > CRATE_MAX_MS) return false;
  return (crateTotalMs()+t.duration_ms) <= CRATE_MAX_MS;
}

function renderSelected(){
  $("selectedCount").textContent = String(selected.length);
  updateCrateDurLabel();
  const ol = $("selected");
  ol.innerHTML = "";
  selected.forEach((t, idx)=>{
    const li = document.createElement("li");
    li.className = "row";
    li.style.borderBottom = "1px solid #eee";
    li.innerHTML = `
      <div style="max-width:70%;">
        <b>${t.name}</b> ‚Äî ${t.artist}<br/>
        <small>${fmtDur(t.duration_ms)} | <a href="${t.url}" target="_blank">View on YouTube</a></small>
      </div>
      <div class="btnRow">
        <button data-act="up">‚Üë</button>
        <button data-act="down">‚Üì</button>
        <button class="danger" data-act="remove">Remove</button>
      </div>
    `;
    li.querySelector('[data-act="up"]').onclick = ()=>{
      if(idx===0) return;
      [selected[idx-1], selected[idx]] = [selected[idx], selected[idx-1]];
      renderSelected(); renderResults(lastSearchItems);
    };
    li.querySelector('[data-act="down"]').onclick = ()=>{
      if(idx===selected.length-1) return;
      [selected[idx+1], selected[idx]] = [selected[idx], selected[idx+1]];
      renderSelected(); renderResults(lastSearchItems);
    };
    li.querySelector('[data-act="remove"]').onclick = ()=>{
      selected.splice(idx,1);
      renderSelected(); renderResults(lastSearchItems);
    };
    ol.appendChild(li);
  });
}

function clearResults(){ lastSearchItems=[]; $("results").innerHTML=""; }

function renderResults(items){
  lastSearchItems = items || [];
  const root = $("results");
  root.innerHTML = "";
  if(!items || !items.length) return;

  const total = crateTotalMs();

  items.forEach((t)=>{
    const tooLong = t.duration_ms > CRATE_MAX_MS;
    const already = isAlreadySelected(t.id);
    const wouldExceed = !already && (total + t.duration_ms > CRATE_MAX_MS);

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="max-width:70%;">
        <b>${t.name}</b> ‚Äî ${t.artist}<br/>
        <small>${fmtDur(t.duration_ms)}
          ${tooLong ? "(too long)" : ""}
          ${wouldExceed ? "(crate full)" : ""}
        </small>
      </div>
      <div class="btnRow">
        <button ${tooLong||already||wouldExceed ? "disabled":""}>
          ${already ? "Added" : (wouldExceed ? "Full" : "Add")}
        </button>
      </div>
    `;
    row.querySelector("button").onclick = ()=>{
      if(tooLong || already) return;
      if(!canAddTrack(t)){
        alert("Crate limit is 10:00 total.");
        return;
      }
      selected.push(t);
      renderSelected();
      renderResults(items);
    };
    root.appendChild(row);
  });
}

async function doSearchAuto(q){
  q = q.trim();
  if(q.length < 2){
    $("searchHint").textContent = "Type at least 2 characters.";
    clearResults();
    return;
  }
  if(q === lastQuery) return;
  lastQuery = q;

  $("searchHint").textContent = "Searching‚Ä¶";
  try{
    // Search for videos
    const searchData = await youtubeSearch(q);
    
    if (!searchData.items || searchData.items.length === 0) {
      $("searchHint").textContent = `No results for: "${q}"`;
      clearResults();
      return;
    }

    // Get video details including duration
    const videoIds = searchData.items.map(item => item.id.videoId).join(',');
    const detailsData = await youtubeGetVideoDetails(videoIds);
    
    const items = detailsData.items.map(video => ({
      id: video.id,
      url: `https://www.youtube.com/watch?v=${video.id}`,
      name: video.snippet.title,
      artist: video.snippet.channelTitle,
      duration_ms: parseDuration(video.contentDetails.duration),
    }));
    
    $("searchHint").textContent = `Results for: "${q}" (tap outside to hide)`;
    renderResults(items);
  } catch(e){
    $("searchHint").textContent = "Search failed (check API key).";
    console.error(e);
  }
}

function onSearchInput(){
  const q = $("searchBox").value;
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>doSearchAuto(q), 250);
}
function onSearchBlur(){
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = setTimeout(()=>{
    clearResults();
    $("searchHint").textContent = "";
  }, 200);
}
function onSearchFocus(){
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = null;
  $("searchHint").textContent = "Type to search (results auto-hide when you tap outside).";
}

function saveCrate(){
  const name = $("crateName").value.trim();
  if(!name) return alert("Enter a crate name.");
  if(!selected.length) return alert("Add some tracks first.");

  const total = crateTotalMs();
  if(total > CRATE_MAX_MS) return alert("Crate total exceeds 10:00.");

  const crates = loadCrates();
  crates.unshift({
    id: crypto.randomUUID(),
    name,
    tracks: [...selected],
    total_ms: total,
    createdAt: Date.now(),
  });
  saveCrates(crates);

  selected.length = 0;
  renderSelected();
  $("crateName").value = "";
  refreshCrates();
  alert("Crate saved.");
}

function refreshCrates(){
  const crates = loadCrates();
  const ul = $("crates");
  ul.innerHTML = "";

  crates.forEach((c)=>{
    const li = document.createElement("li");
    li.className = "row";
    li.innerHTML = `
      <div style="max-width:70%;">
        <b>${c.name}</b>
        <span class="chip">${c.tracks.length} tracks</span>
        <span class="chip">${fmtDur(c.total_ms || 0)}</span><br/>
        <small>${new Date(c.createdAt).toLocaleString()}</small>
      </div>
<<<<<<< HEAD
      <div class="crate-actions">
        <button class="btn-success" data-act="send" ${ble.connected ? "" : "disabled"}>Burn Vinyl</button>
        <button class="btn-secondary" data-act="load">Load</button>
        <button class="btn-danger" data-act="del">Delete</button>
=======
      <div class="btnRow">
        <button data-act="send" ${ble.connected ? "" : "disabled"}>Send + Download</button>
        <button data-act="load">Load</button>
        <button class="danger" data-act="del">Delete</button>
>>>>>>> parent of 186e709 (Finished????)
      </div>
    `;

    li.querySelector('[data-act="send"]').onclick = async ()=>{
      if(!ble.connected) return alert("Connect BLE first.");

<<<<<<< HEAD
      // Store the crate for later use after NFC scan
      window.currentCrateToBurn = c;
      
      // Show NFC modal
      showNfcModal();
=======
      showDlUI(true);
      setDlProgress(0, "Sending crate to Pi‚Ä¶");

      const safe = (s)=>String(s||"").replace(/\|/g," ").replace(/\n/g," ").trim();

      await bleWriteLine(`CRATE_BEGIN ${safe(c.name)}`);
      await bleWriteLine(`CRATE_TOTAL_MS ${c.total_ms || 0}`);
      for(const t of c.tracks){
        await bleWriteLine(`CRATE_TRACK ${safe(t.id)}|${t.duration_ms||0}|${safe(t.url)}|${safe(t.name)}|${safe(t.artist)}`);
      }
      await bleWriteLine("CRATE_END");

      setDlProgress(0, "Starting yt-dlp on Pi‚Ä¶");
      await bleWriteLine(`DL_START ${safe(c.name)}`);
>>>>>>> parent of 186e709 (Finished????)
    };

    li.querySelector('[data-act="load"]').onclick = ()=>{
      selected.length = 0;
      c.tracks.forEach(t=>selected.push(t));
      renderSelected();
      $("crateName").value = c.name;
      alert("Crate loaded.");
    };

    li.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm(`Delete crate "${c.name}"?`)) return;
      saveCrates(crates.filter(x=>x.id!==c.id));
      refreshCrates();
    };

    ul.appendChild(li);
  });
}
/* ================================================================ */

<<<<<<< HEAD
/* ======================== Advanced Options Modal ======================== */
function showAdvancedOptions() {
  const overlay = document.getElementById('advancedOverlay');
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function hideAdvancedOptions() {
  const overlay = document.getElementById('advancedOverlay');
  overlay.style.display = 'none';
  document.body.style.overflow = ''; // Restore background scrolling
}
/* ================================================================ */

=======
>>>>>>> parent of 186e709 (Finished????)
/* ======================== Wire UI ======================== */
$("bleConnectBtn").onclick = async ()=>{
  try { await bleConnect(); }
  catch(e){ safeAlertBleError(e); cleanupBleState(); $("bleConnectBtn").disabled = false; }
};

$("logoTitle").onclick = ()=> showAdvancedOptions();
$("closeAdvanced").onclick = ()=> hideAdvancedOptions();

// Close modal when clicking outside
document.getElementById('advancedOverlay').onclick = (e)=> {
  if(e.target.id === 'advancedOverlay') hideAdvancedOptions();
};

$("bleDisconnectBtn").onclick = ()=> bleDisconnect();

$("statusBtn").onclick = ()=> statusOnce().catch(e=> safeAlertBleError(e));
$("startPollBtn").onclick = ()=> startPoll();
$("stopPollBtn").onclick = ()=> stopPoll();

$("wifiScanBtn").onclick = ()=> wifiScan().catch(e=> safeAlertBleError(e));
$("wifiJoinBtn").onclick = ()=> wifiJoin().catch(e=> safeAlertBleError(e));
$("wifiStatusBtn").onclick = ()=> wifiStatus().catch(e=> safeAlertBleError(e));
$("wifiOffBtn").onclick = ()=> wifiOff().catch(e=> safeAlertBleError(e));

$("searchBox").addEventListener("input", onSearchInput);
$("searchBox").addEventListener("blur", onSearchBlur);
$("searchBox").addEventListener("focus", onSearchFocus);

$("nfcCancelBtn").onclick = ()=> hideNfcModal();
$("nfcScanBtn").onclick = async ()=> {
  await scanNfc();
  
  // After NFC scan completes, start the burn process
  const crates = loadCrates();
  // Find the crate that triggered this (we'll need to store it)
  const c = window.currentCrateToBurn;
  if (!c) return;
  
  showDlUI(true);
  setDlProgress(0, "Sending crate to Pi...");

  const safe = (s)=>String(s||"").replace(/\|/g," ").replace(/\n/g," ").trim();

  try {
    await bleWriteLine(`CRATE_BEGIN ${safe(c.name)}`);
    await bleWriteLine(`CRATE_TOTAL_MS ${c.total_ms || 0}`);
    for(const t of c.tracks) {
      await bleWriteLine(`CRATE_TRACK ${safe(t.id)}|${t.duration_ms||0}|${safe(t.url)}|${safe(t.name)}|${safe(t.artist)}`);
    }
    await bleWriteLine("CRATE_END");

    setDlProgress(0, "Starting download...");
    await bleWriteLine(`DL_START ${safe(c.name)}`);
    showToast("Crate sent to Pi!", 'success');
  } catch(e) {
    showToast("Failed to send crate", 'error');
    showDlUI(false);
  }
};

$("saveCrateBtn").onclick = ()=> saveCrate();
$("refreshCratesBtn").onclick = ()=> refreshCrates();
$("clearSelectedBtn").onclick = ()=>{
  selected.length = 0;
  renderSelected();
  renderResults(lastSearchItems);
};
/* ================================================================ */

/* ======================== Boot ======================== */
setBleUi(false);
wifiRenderNets();
renderSelected();
refreshCrates();

(function boot(){
  $("env").textContent =
    `secureContext=${window.isSecureContext} | navigator.bluetooth=${!!navigator.bluetooth} | url=${location.href}`;

  $("searchHint").textContent = "Type to search YouTube Music (results auto-hide when you tap outside).";
})();
</script>
</body>
</html>