<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BurnVinyl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --cream: #f8f5f0;
      --warm-white: #faf8f5;
      --charcoal: #2a2522;
      --deep-brown: #3d3330;
      --burgundy: #8b2635;
      --deep-red: #a23545;
      --warm-red: #c14554;
      --gold: #d4a574;
      --light-gold: #e6c9a0;
      --border-subtle: #e0d5c7;
      --text-primary: #2a2522;
      --text-secondary: #6b5d54;
      --text-muted: #9a8a7d;
    }

    body {
      font-family: 'Crimson Text', serif;
      background: var(--cream);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    /* Subtle texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(42, 37, 34, 0.02) 2px, rgba(42, 37, 34, 0.02) 4px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.3;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 100%;
      padding: 0;
    }

    /* Header */
    header {
      background: linear-gradient(180deg, var(--warm-white) 0%, var(--cream) 100%);
      padding: 32px 24px 24px;
      border-bottom: 3px solid var(--burgundy);
      box-shadow: 0 2px 12px rgba(139, 38, 53, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 42px;
      font-weight: 900;
      letter-spacing: -1px;
      color: var(--burgundy);
      margin-bottom: 8px;
      text-align: center;
    }

    .tagline {
      font-family: 'Crimson Text', serif;
      font-size: 16px;
      font-style: italic;
      color: var(--text-secondary);
      text-align: center;
      letter-spacing: 0.5px;
    }

    /* Cards */
    .card {
      background: var(--warm-white);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      margin: 24px 16px;
      padding: 28px 24px;
      box-shadow: 
        0 1px 3px rgba(42, 37, 34, 0.06),
        0 4px 12px rgba(42, 37, 34, 0.04);
      animation: cardSlideIn 0.6s ease-out;
      position: relative;
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--burgundy), var(--deep-red), var(--warm-red));
    }

    .card h2 {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--burgundy);
      margin-bottom: 20px;
      letter-spacing: -0.5px;
    }

    /* Buttons */
    button {
      font-family: 'Crimson Text', serif;
      padding: 14px 24px;
      border: none;
      border-radius: 2px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: var(--burgundy);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(139, 38, 53, 0.25);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(139, 38, 53, 0.2);
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:active {
      background: var(--border-subtle);
      transform: translateY(1px);
    }

    .btn-success {
      background: var(--deep-brown);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(61, 51, 48, 0.25);
    }

    .btn-danger {
      background: var(--warm-red);
      color: var(--warm-white);
      box-shadow: 0 2px 8px rgba(193, 69, 84, 0.25);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .btn-row button {
      flex: 1;
      min-width: 120px;
    }

    /* Input fields */
    input, select {
      font-family: 'Crimson Text', serif;
      width: 100%;
      padding: 14px 16px;
      background: var(--cream);
      border: 2px solid var(--border-subtle);
      border-radius: 2px;
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--burgundy);
      box-shadow: 0 0 0 3px rgba(139, 38, 53, 0.1);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    /* Search */
    .search-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      margin-top: 6px;
    }

    input[type="text"] {
      padding-left: 48px;
    }

    .search-hint {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 12px;
      min-height: 20px;
      font-style: italic;
    }

    /* Results */
    .results-list {
      margin-top: 16px;
    }

    .track-item {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-left: 4px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      animation: trackSlideIn 0.4s ease-out;
    }

    @keyframes trackSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .track-item:active {
      transform: scale(0.98);
      background: var(--border-subtle);
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-weight: 700;
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .track-meta {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .track-item button {
      flex-shrink: 0;
      min-width: 90px;
      padding: 10px 18px;
    }

    .duration-badge {
      display: inline-block;
      padding: 3px 10px;
      background: var(--warm-white);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      font-size: 13px;
      color: var(--burgundy);
      font-weight: 600;
    }

    .warning-badge {
      color: var(--warm-red);
      border-color: var(--warm-red);
    }

    /* Crate list */
    .crate-counter {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: var(--cream);
      border-radius: 2px;
      border: 1px solid var(--border-subtle);
    }

    .counter-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
    }

    .counter-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--burgundy);
      font-family: 'Playfair Display', serif;
    }

    .selected-tracks {
      list-style: none;
      margin: 20px 0;
    }

    .selected-tracks li {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-left: 4px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px;
      margin-bottom: 14px;
      animation: trackSlideIn 0.4s ease-out;
    }

    .track-controls {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .track-controls button {
      flex: 1;
      padding: 10px 14px;
      font-size: 14px;
    }

    /* Log */
    .log-container {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      padding: 14px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 16px;
      font-family: 'Crimson Text', serif;
      line-height: 1.8;
    }

    .log-container::-webkit-scrollbar {
      width: 8px;
    }

    .log-container::-webkit-scrollbar-track {
      background: var(--warm-white);
    }

    .log-container::-webkit-scrollbar-thumb {
      background: var(--border-subtle);
      border-radius: 4px;
    }

    /* Collapsible sections */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 10px 0;
    }

    .collapsible-header::after {
      content: '‚ñº';
      font-size: 14px;
      color: var(--text-muted);
      transition: transform 0.3s ease;
    }

    .collapsible-header.collapsed::after {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .collapsible-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    /* Saved crates */
    .crate-list {
      list-style: none;
    }

    .crate-list-item {
      background: var(--cream);
      border: 1px solid var(--border-subtle);
      border-radius: 2px;
      padding: 20px;
      margin-bottom: 16px;
      animation: trackSlideIn 0.4s ease-out;
    }

    .crate-header {
      margin-bottom: 16px;
    }

    .crate-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-family: 'Playfair Display', serif;
    }

    .crate-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 600;
      background: var(--warm-white);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .badge-tracks {
      color: var(--burgundy);
      border-color: var(--burgundy);
    }

    .badge-duration {
      color: var(--deep-brown);
      border-color: var(--deep-brown);
    }

    .crate-date {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 10px;
      font-style: italic;
    }

    .crate-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .crate-actions button {
      flex: 1;
      font-size: 14px;
      padding: 12px 16px;
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.4;
    }

    /* Utility classes */
    .hidden {
      display: none !important;
    }

    .mt-16 {
      margin-top: 16px;
    }

    .mb-16 {
      margin-bottom: 16px;
    }

    /* Link styling */
    a {
      color: var(--burgundy);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:active {
      color: var(--deep-red);
    }

    /* Section divider */
    .section-number {
      display: inline-block;
      width: 32px;
      height: 32px;
      background: var(--burgundy);
      border-radius: 50%;
      text-align: center;
      line-height: 32px;
      font-weight: 700;
      font-size: 16px;
      color: var(--warm-white);
      margin-right: 12px;
      font-family: 'Playfair Display', serif;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--warm-white);
      border: 2px solid var(--burgundy);
      border-radius: 2px;
      padding: 18px 28px;
      box-shadow: 0 8px 32px rgba(42, 37, 34, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      border-color: var(--warm-red);
      color: var(--warm-red);
    }

    .toast.success {
      border-color: var(--deep-brown);
      color: var(--deep-brown);
    }

    /* Wi-Fi network list */
    .network-option {
      padding: 14px;
      background: var(--cream);
    }

    /* Fixed bottom progress bar */
    .progress-bar-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--warm-white);
      border-top: 2px solid var(--burgundy);
      padding: 16px 20px;
      box-shadow: 0 -4px 20px rgba(42, 37, 34, 0.1);
      z-index: 200;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-bar-fixed.visible {
      transform: translateY(0);
    }

    .download-status {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--burgundy);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--cream);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
      border: 1px solid var(--border-subtle);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--burgundy), var(--deep-red));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .download-message {
      font-size: 13px;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Better mobile spacing */
    @media (max-width: 768px) {
      .card {
        margin: 16px 12px;
        padding: 20px 16px;
      }

      h1 {
        font-size: 32px;
      }

      .btn-row button {
        min-width: 100px;
        font-size: 14px;
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BurnVinyl</h1>
    </header>

    <!-- BLE Connection -->
    <div class="card">
      <h2><span class="section-number">1</span> Bluetooth Connection</h2>
      
      <div class="btn-row">
        <button id="bleConnectBtn" class="btn-primary">Connect to Pi</button>
        <button id="bleDisconnectBtn" class="btn-danger" disabled>Disconnect</button>
      </div>

      <div class="collapsible-header collapsed" id="bleAdvancedHeader">
        <span style="color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600;">Advanced Options</span>
      </div>
      
      <div class="collapsible-content collapsed" id="bleAdvancedContent">
        <select id="bleMode">
          <option value="uuid" selected>Filter by UART UUID</option>
          <option value="name">Filter by Name (DVS)</option>
        </select>

        <div class="btn-row">
          <button id="statusBtn" class="btn-secondary" disabled>Check Status</button>
          <button id="startPollBtn" class="btn-secondary" disabled>Start Poll</button>
          <button id="stopPollBtn" class="btn-secondary" disabled>Stop Poll</button>
        </div>

        <div class="log-container" id="bleLog"></div>
      </div>
    </div>

    <!-- Wi-Fi -->
    <div class="card">
      <h2><span class="section-number">2</span> Wi-Fi Setup</h2>
      
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; font-style: italic;">
        Connect your Pi to Wi-Fi for downloads. You can disable Wi-Fi during playback.
      </p>

      <div class="btn-row">
        <button id="wifiScanBtn" class="btn-secondary" disabled>Scan Networks</button>
        <button id="wifiStatusBtn" class="btn-secondary" disabled>Check Status</button>
        <button id="wifiOffBtn" class="btn-danger" disabled>Turn Off</button>
      </div>

      <select id="wifiSsid" disabled>
        <option value="">(scan for networks first)</option>
      </select>

      <input id="wifiPass" type="password" placeholder="Wi-Fi password (leave blank if open)" disabled />

      <div class="btn-row">
        <button id="wifiJoinBtn" class="btn-success" disabled>Connect to Network</button>
      </div>

      <div style="margin-top: 20px; padding: 16px; background: var(--cream); border-radius: 2px; font-size: 14px; border: 1px solid var(--border-subtle);">
        <div style="color: var(--text-secondary); margin-bottom: 6px;">
          Status: <span id="wifiState" style="color: var(--burgundy); font-weight: 600;">unknown</span>
        </div>
        <div style="color: var(--text-secondary);">
          IP: <span id="wifiIp" style="color: var(--burgundy); font-weight: 600;">-</span>
        </div>
      </div>
    </div>

    <!-- Search -->
    <div class="card">
      <h2><span class="section-number">3</span> Search Music</h2>
      
      <div class="search-wrapper">
        <div class="search-icon">üîç</div>
        <input id="searchBox" type="text" placeholder="Search for tracks on YouTube..." />
      </div>
      <div class="search-hint" id="searchHint">Type to search tracks</div>

      <div class="crate-counter">
        <div>
          <div class="counter-label">Crate Limit</div>
          <div style="font-size: 14px; color: var(--text-muted); margin-top: 6px;">10:00 max</div>
        </div>
        <div style="margin-left: auto; text-align: right;">
          <div class="counter-label">Current</div>
          <div class="counter-value" id="crateDurLabel">0:00</div>
        </div>
      </div>

      <div class="results-list" id="results"></div>
    </div>

    <!-- Current Crate -->
    <div class="card">
      <h2><span class="section-number">4</span> Current Playlist</h2>
      
      <div class="crate-counter">
        <div>
          <div class="counter-label">Tracks</div>
          <div class="counter-value" id="selectedCount">0</div>
        </div>
        <div style="margin-left: auto;">
          <button id="clearSelectedBtn" class="btn-danger" style="padding: 10px 18px; font-size: 14px;">Clear All</button>
        </div>
      </div>

      <ol class="selected-tracks" id="selected"></ol>

      <input id="crateName" type="text" placeholder="Name your crate (e.g., Friday Night Set)" />
      
      <div style="font-size: 13px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
      </div>

      <div class="btn-row">
        <button id="saveCrateBtn" class="btn-success">Save Crate</button>
      </div>
    </div>

    <!-- Saved Crates -->
    <div class="card">
      <h2><span class="section-number">5</span> Your Crates</h2>
      
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; font-style: italic;">
        Saved locally on your device
      </p>

      <button id="refreshCratesBtn" class="btn-secondary" style="width: 100%; margin-bottom: 20px;">Refresh List</button>

      <ul class="crate-list" id="crates"></ul>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <!-- Fixed bottom progress bar -->
  <div class="progress-bar-fixed" id="dlRow">
    <div class="download-status">
      <span>Downloading</span>
      <span id="dlPct" style="font-family: 'Playfair Display', serif;">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="dlProg" style="width: 0%"></div>
    </div>
    <div class="download-message" id="dlMsg">Starting download...</div>
  </div>

<script>
/* ======================== CHANGE ME (YouTube) ======================== */
const YOUTUBE_API_KEY = "AIzaSyAcahPuv_d4f1GS3PkA2HBVfE6TryHeeMM";
const CRATE_MAX_MS = 10 * 60 * 1000;
/* ================================================================ */

/* ======================== BLE Nordic UART UUIDs ======================== */
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
const UART_TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
/* ================================================================ */

const $ = (id) => document.getElementById(id);

function logBle(msg) { 
  const log = $("bleLog");
  const entry = document.createElement('div');
  entry.textContent = msg;
  entry.style.animation = 'trackSlideIn 0.3s ease-out';
  log.insertBefore(entry, log.firstChild);
}

function showToast(msg, type = 'info') {
  const toast = $("toast");
  toast.textContent = msg;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

const enc = (s) => new TextEncoder().encode(s);
const dec = (u8) => new TextDecoder().decode(u8);

/* ======================== Download UI ======================== */
function showDlUI(show) {
  const dlRow = $("dlRow");
  if (show) {
    dlRow.classList.add('visible');
  } else {
    dlRow.classList.remove('visible');
  }
}

function setDlProgress(pct, msg) {
  pct = Math.max(0, Math.min(100, (pct|0)));
  $("dlProg").style.width = pct + "%";
  $("dlPct").textContent = pct + "%";
  $("dlMsg").textContent = msg || "";
}
/* ================================================================ */

/* ======================== Local crate storage ======================== */
const LS_KEY = "veeneeleo_crates_v1";
function loadCrates() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch { return []; }
}
function saveCrates(crates) {
  localStorage.setItem(LS_KEY, JSON.stringify(crates));
}
/* ================================================================ */

/* ======================== BLE ======================== */
let ble = {
  device: null,
  server: null,
  svc: null,
  rx: null,
  tx: null,
  connected: false,
  notifyBuf: "",
  pollTimer: null,
  lastStatus: {ready: false, lock: false, posMs: 0, rate: 1.0},
};

function setBleUi(connected) {
  $("bleConnectBtn").disabled = connected;
  $("bleDisconnectBtn").disabled = !connected;
  $("statusBtn").disabled = !connected;
  $("startPollBtn").disabled = !connected;
  $("stopPollBtn").disabled = !connected;

  $("wifiScanBtn").disabled = !connected;
  $("wifiStatusBtn").disabled = !connected;
  $("wifiOffBtn").disabled = !connected;
  $("wifiSsid").disabled = !connected;
  $("wifiPass").disabled = !connected;
  $("wifiJoinBtn").disabled = !connected;
}

function safeAlertBleError(e) {
  console.error("BLE error:", e);
  const name = e?.name || "n/a";
  const msg = e?.message || String(e);
  showToast(`BLE Error: ${msg}`, 'error');
}

function onBleText(text) {
  ble.notifyBuf += text;
  let idx;
  while((idx = ble.notifyBuf.indexOf("\n")) >= 0) {
    const line = ble.notifyBuf.slice(0, idx).trim();
    ble.notifyBuf = ble.notifyBuf.slice(idx + 1);
    if(!line) continue;

    if (line.startsWith("READY ")) ble.lastStatus.ready = line.endsWith("1");
    else if (line.startsWith("LOCK ")) ble.lastStatus.lock = line.endsWith("1");
    else if (line.startsWith("POS_MS ")) ble.lastStatus.posMs = parseInt(line.slice(7), 10) || 0;
    else if (line.startsWith("RATE ")) ble.lastStatus.rate = parseFloat(line.slice(5)) || 0;

    else if (line.startsWith("DL_PCT ")) {
      showDlUI(true);
      setDlProgress(parseInt(line.slice(7),10)||0, $("dlMsg").textContent);
    } else if (line.startsWith("DL_MSG ")) {
      showDlUI(true);
      setDlProgress(parseInt($("dlProg").style.width)||0, line.slice(7));
    } else if (line === "DL_DONE") {
      setDlProgress(100, "Download complete!");
      showToast("Download complete!", 'success');
      setTimeout(()=>showDlUI(false), 3000);
    } else if (line.startsWith("DL_ERR ")) {
      showDlUI(true);
      const err = line.slice(7);
      setDlProgress(parseInt($("dlProg").style.width)||0, "Error: " + err);
      showToast("Download failed: " + err, 'error');
    }

    else if (line.startsWith("WIFI_NET ")) {
      const payload = line.slice(9);
      const [ssid, sig] = payload.split("|");
      const signal = parseInt(sig||"0",10)||0;
      if(ssid && ssid.trim()) {
        const s = ssid.trim();
        const i = wifiNets.findIndex(x=>x.ssid===s);
        if(i>=0) wifiNets[i].signal = Math.max(wifiNets[i].signal, signal);
        else wifiNets.push({ssid:s, signal});
      }
    } else if (line === "WIFI_SCAN_DONE") {
      wifiNets.sort((a,b)=>b.signal-a.signal);
      wifiRenderNets();
      logBle("Wi-Fi scan complete");
      showToast("Found " + wifiNets.length + " networks", 'success');
    } else if (line.startsWith("WIFI_STATE ")) {
      wifiSetState(line.slice(11).trim(), $("wifiIp").textContent === "-" ? "" : $("wifiIp").textContent);
    } else if (line.startsWith("WIFI_IP ")) {
      wifiSetState($("wifiState").textContent, line.slice(8).trim());
    } else if (line.startsWith("WIFI_ERR ")) {
      showToast("Wi-Fi error: " + line.slice(9), 'error');
    }

    logBle(line);
  }
}

async function bleWriteLine(line) {
  if(!ble.connected || !ble.rx) throw new Error("Not connected");
  if(!line.endsWith("\n")) line += "\n";
  const data = enc(line);

  if (ble.rx.writeValue) await ble.rx.writeValue(data);
  else await ble.rx.writeValueWithoutResponse(data);
}

function stopPoll() {
  if(ble.pollTimer) clearInterval(ble.pollTimer);
  ble.pollTimer = null;
}

async function statusOnce() {
  await bleWriteLine("STATUS");
}

function startPoll() {
  stopPoll();
  ble.pollTimer = setInterval(()=>{
    if(ble.connected) bleWriteLine("STATUS").catch(()=>{});
  }, 300);
  logBle("Polling status...");
}

function cleanupBleState() {
  stopPoll();
  ble.connected = false;
  ble.server = null;
  ble.svc = null;
  ble.rx = null;
  ble.tx = null;
  setBleUi(false);
  refreshCrates();
}

async function bleConnect() {
  if(!window.isSecureContext) throw new Error("Must be HTTPS");
  if(!navigator.bluetooth) throw new Error("WebBluetooth not available");

  $("bleConnectBtn").disabled = true;

  try {
    logBle("Requesting device...");
    showToast("Opening Bluetooth picker...", 'info');

    const mode = $("bleMode").value;

    if(mode === "name") {
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: "DVS" }],
        optionalServices: [UART_SERVICE_UUID],
      });
    } else {
      ble.device = await navigator.bluetooth.requestDevice({
        filters: [{ services: [UART_SERVICE_UUID] }],
        optionalServices: [UART_SERVICE_UUID],
      });
    }

    ble.device.addEventListener("gattserverdisconnected", ()=>{
      logBle("GATT disconnected");
      showToast("Bluetooth disconnected", 'error');
      cleanupBleState();
    });

    logBle("Connecting to GATT...");
    ble.server = await ble.device.gatt.connect();

    logBle("Getting UART service...");
    ble.svc = await ble.server.getPrimaryService(UART_SERVICE_UUID);

    logBle("Getting characteristics...");
    ble.rx = await ble.svc.getCharacteristic(UART_RX_UUID);
    ble.tx = await ble.svc.getCharacteristic(UART_TX_UUID);

    logBle("Enabling notifications...");
    await ble.tx.startNotifications();

    ble.tx.addEventListener("characteristicvaluechanged", (ev)=>{
      const v = ev.target.value;
      const bytes = new Uint8Array(v.buffer);
      onBleText(dec(bytes));
    });

    ble.connected = true;
    setBleUi(true);
    refreshCrates();
    logBle("‚úÖ BLE connected");
    showToast("Connected to Pi!", 'success');
  } finally {
    $("bleConnectBtn").disabled = ble.connected;
  }
}

async function bleDisconnect() {
  try {
    stopPoll();
    if(ble.device?.gatt?.connected) ble.device.gatt.disconnect();
  } catch {}
  cleanupBleState();
  logBle("BLE disconnected");
  showToast("Disconnected", 'info');
}
/* ================================================================ */

/* ======================== Wi-Fi UI ======================== */
let wifiNets = [];

function wifiRenderNets() {
  const sel = $("wifiSsid");
  sel.innerHTML = "";
  if(!wifiNets.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(no networks ‚Äî tap Scan)";
    sel.appendChild(opt);
    return;
  }
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "(choose a network)";
  sel.appendChild(opt0);
  wifiNets.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n.ssid;
    opt.textContent = `${n.ssid} (${n.signal}%)`;
    sel.appendChild(opt);
  });
}

function wifiSetState(state, ip="") {
  $("wifiState").textContent = state || "unknown";
  $("wifiIp").textContent = ip || "-";
}

async function wifiScan() {
  if(!ble.connected) return showToast("Connect to Pi first", 'error');
  wifiNets = [];
  wifiRenderNets();
  wifiSetState("scanning","");
  await bleWriteLine("WIFI_SCAN");
  showToast("Scanning for networks...", 'info');
}

async function wifiJoin() {
  if(!ble.connected) return showToast("Connect to Pi first", 'error');
  const ssid = $("wifiSsid").value;
  const pwd = $("wifiPass").value;
  if(!ssid) return showToast("Choose a network first", 'error');
  wifiSetState("connecting","");
  await bleWriteLine(`WIFI_JOIN ${ssid}|${pwd}`);
  showToast("Connecting to " + ssid + "...", 'info');
}

async function wifiStatus() {
  if(!ble.connected) return showToast("Connect to Pi first", 'error');
  await bleWriteLine("WIFI_STATUS");
}

async function wifiOff() {
  if(!ble.connected) return showToast("Connect to Pi first", 'error');
  await bleWriteLine("WIFI_OFF");
  showToast("Turning Wi-Fi off...", 'info');
}
/* ================================================================ */

/* ======================== YouTube API ======================== */
async function youtubeSearch(query) {
  if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY.includes("YOUR_")) {
    throw new Error("Set YOUTUBE_API_KEY first");
  }
  
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&videoCategoryId=10&q=${encodeURIComponent(query + " music")}&key=${YOUTUBE_API_KEY}`;
  
  const r = await fetch(url);
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}

async function youtubeGetVideoDetails(videoIds) {
  const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
  
  const r = await fetch(url);
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}
/* ================================================================ */

/* ======================== Search & Crate ======================== */
const selected = [];
let lastSearchItems = [];
let searchTimer = null;
let lastQuery = "";
let blurHideTimer = null;

function fmtDur(ms) {
  const s = Math.round(ms/1000);
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${String(r).padStart(2,'0')}`;
}

function parseDuration(duration) {
  const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  if (!match) return 0;
  
  const hours = parseInt(match[1] || 0);
  const minutes = parseInt(match[2] || 0);
  const seconds = parseInt(match[3] || 0);
  
  return (hours * 3600 + minutes * 60 + seconds) * 1000;
}

function crateTotalMs() {
  return selected.reduce((a,t)=>a+(t.duration_ms||0),0);
}

function updateCrateDurLabel() {
  $("crateDurLabel").textContent = fmtDur(crateTotalMs());
}

function isAlreadySelected(id) {
  return selected.some(t=>t.id===id);
}

function canAddTrack(t) {
  if(!t) return false;
  if(t.duration_ms > CRATE_MAX_MS) return false;
  return (crateTotalMs()+t.duration_ms) <= CRATE_MAX_MS;
}

function renderSelected() {
  $("selectedCount").textContent = String(selected.length);
  updateCrateDurLabel();
  const ol = $("selected");
  ol.innerHTML = "";
  
  if (selected.length === 0) {
    ol.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéµ</div><div>No tracks selected yet</div></div>';
    return;
  }
  
  selected.forEach((t, idx)=>{
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="track-info">
        <div class="track-name">${t.name}</div>
        <div class="track-meta">
          ${t.artist} ‚Ä¢ <span class="duration-badge">${fmtDur(t.duration_ms)}</span>
        </div>
      </div>
      <div class="track-controls">
        <button class="btn-secondary" data-act="up" ${idx===0?'disabled':''}>‚Üë</button>
        <button class="btn-secondary" data-act="down" ${idx===selected.length-1?'disabled':''}>‚Üì</button>
        <button class="btn-danger" data-act="remove">‚úï</button>
      </div>
    `;
    
    li.querySelector('[data-act="up"]').onclick = ()=>{
      if(idx===0) return;
      [selected[idx-1], selected[idx]] = [selected[idx], selected[idx-1]];
      renderSelected();
      renderResults(lastSearchItems);
    };
    
    li.querySelector('[data-act="down"]').onclick = ()=>{
      if(idx===selected.length-1) return;
      [selected[idx+1], selected[idx]] = [selected[idx], selected[idx+1]];
      renderSelected();
      renderResults(lastSearchItems);
    };
    
    li.querySelector('[data-act="remove"]').onclick = ()=>{
      selected.splice(idx,1);
      renderSelected();
      renderResults(lastSearchItems);
      showToast("Track removed", 'info');
    };
    
    ol.appendChild(li);
  });
}

function clearResults() {
  lastSearchItems = [];
  $("results").innerHTML = "";
}

function renderResults(items) {
  lastSearchItems = items || [];
  const root = $("results");
  root.innerHTML = "";
  if(!items || !items.length) return;

  const total = crateTotalMs();

  items.forEach((t)=>{
    const tooLong = t.duration_ms > CRATE_MAX_MS;
    const already = isAlreadySelected(t.id);
    const wouldExceed = !already && (total + t.duration_ms > CRATE_MAX_MS);

    const div = document.createElement("div");
    div.className = "track-item";
    
    let meta = `${fmtDur(t.duration_ms)}`;
    if (tooLong) meta += ' <span class="duration-badge warning-badge">(too long)</span>';
    if (wouldExceed) meta += ' <span class="duration-badge warning-badge">(crate full)</span>';
    
    div.innerHTML = `
      <div class="track-info">
        <div class="track-name">${t.name}</div>
        <div class="track-meta">${t.artist} ‚Ä¢ ${meta}</div>
      </div>
      <button class="btn-primary" ${tooLong||already||wouldExceed ? "disabled":""}>
        ${already ? "‚úì Added" : (wouldExceed ? "Full" : "+ Add")}
      </button>
    `;
    
    div.querySelector("button").onclick = ()=>{
      if(tooLong || already) return;
      if(!canAddTrack(t)) {
        showToast("Crate limit is 10:00 total", 'error');
        return;
      }
      selected.push(t);
      renderSelected();
      renderResults(items);
      showToast("Track added!", 'success');
    };
    
    root.appendChild(div);
  });
}

async function doSearchAuto(q) {
  q = q.trim();
  if(q.length < 2) {
    $("searchHint").textContent = "Type at least 2 characters";
    clearResults();
    return;
  }
  if(q === lastQuery) return;
  lastQuery = q;

  $("searchHint").textContent = "Searching YouTube...";
  try {
    const searchData = await youtubeSearch(q);
    
    if (!searchData.items || searchData.items.length === 0) {
      $("searchHint").textContent = `No results for "${q}"`;
      clearResults();
      return;
    }

    const videoIds = searchData.items.map(item => item.id.videoId).join(',');
    const detailsData = await youtubeGetVideoDetails(videoIds);
    
    const items = detailsData.items.map(video => ({
      id: video.id,
      url: `https://www.youtube.com/watch?v=${video.id}`,
      name: video.snippet.title,
      artist: video.snippet.channelTitle,
      duration_ms: parseDuration(video.contentDetails.duration),
    }));
    
    $("searchHint").textContent = `Found ${items.length} results for "${q}"`;
    renderResults(items);
  } catch(e) {
    $("searchHint").textContent = "Search failed (check API key)";
    console.error(e);
    showToast("Search failed", 'error');
  }
}

function onSearchInput() {
  const q = $("searchBox").value;
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>doSearchAuto(q), 400);
}

function onSearchBlur() {
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = setTimeout(()=>{
    clearResults();
    $("searchHint").textContent = "";
  }, 200);
}

function onSearchFocus() {
  if(blurHideTimer) clearTimeout(blurHideTimer);
  blurHideTimer = null;
  $("searchHint").textContent = "Type to search tracks";
}

function saveCrate() {
  const name = $("crateName").value.trim();
  if(!name) return showToast("Enter a crate name", 'error');
  if(!selected.length) return showToast("Add some tracks first", 'error');

  const total = crateTotalMs();
  if(total > CRATE_MAX_MS) return showToast("Crate exceeds 10:00 limit", 'error');

  const crates = loadCrates();
  crates.unshift({
    id: crypto.randomUUID(),
    name,
    tracks: [...selected],
    total_ms: total,
    createdAt: Date.now(),
  });
  saveCrates(crates);

  selected.length = 0;
  renderSelected();
  $("crateName").value = "";
  refreshCrates();
  showToast("Crate saved!", 'success');
}

function refreshCrates() {
  const crates = loadCrates();
  const ul = $("crates");
  ul.innerHTML = "";
  
  if (crates.length === 0) {
    ul.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>No saved crates yet</div></div>';
    return;
  }

  crates.forEach((c)=>{
    const li = document.createElement("li");
    li.className = "crate-list-item";
    li.innerHTML = `
      <div class="crate-header">
        <div class="crate-title">${c.name}</div>
        <div class="crate-badges">
          <span class="badge badge-tracks">${c.tracks.length} tracks</span>
          <span class="badge badge-duration">${fmtDur(c.total_ms || 0)}</span>
        </div>
        <div class="crate-date">${new Date(c.createdAt).toLocaleDateString()} ${new Date(c.createdAt).toLocaleTimeString()}</div>
      </div>
      <div class="crate-actions">
        <button class="btn-success" data-act="send" ${ble.connected ? "" : "disabled"}>Send & Download</button>
        <button class="btn-secondary" data-act="load">Load</button>
        <button class="btn-danger" data-act="del">Delete</button>
      </div>
    `;

    li.querySelector('[data-act="send"]').onclick = async ()=>{
      if(!ble.connected) return showToast("Connect to Pi first", 'error');

      showDlUI(true);
      setDlProgress(0, "Sending crate to Pi...");

      const safe = (s)=>String(s||"").replace(/\|/g," ").replace(/\n/g," ").trim();

      try {
        await bleWriteLine(`CRATE_BEGIN ${safe(c.name)}`);
        await bleWriteLine(`CRATE_TOTAL_MS ${c.total_ms || 0}`);
        for(const t of c.tracks) {
          await bleWriteLine(`CRATE_TRACK ${safe(t.id)}|${t.duration_ms||0}|${safe(t.url)}|${safe(t.name)}|${safe(t.artist)}`);
        }
        await bleWriteLine("CRATE_END");

        setDlProgress(0, "Starting download...");
        await bleWriteLine(`DL_START ${safe(c.name)}`);
        showToast("Crate sent to Pi!", 'success');
      } catch(e) {
        showToast("Failed to send crate", 'error');
        showDlUI(false);
      }
    };

    li.querySelector('[data-act="load"]').onclick = ()=>{
      selected.length = 0;
      c.tracks.forEach(t=>selected.push(t));
      renderSelected();
      $("crateName").value = c.name;
      showToast("Crate loaded!", 'success');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    li.querySelector('[data-act="del"]').onclick = ()=>{
      if(!confirm(`Delete crate "${c.name}"?`)) return;
      saveCrates(crates.filter(x=>x.id!==c.id));
      refreshCrates();
      showToast("Crate deleted", 'info');
    };

    ul.appendChild(li);
  });
}
/* ================================================================ */

/* ======================== Collapsible sections ======================== */
function setupCollapsible(headerId, contentId) {
  const header = $(headerId);
  const content = $(contentId);
  
  header.onclick = ()=>{
    const isCollapsed = content.classList.contains('collapsed');
    content.classList.toggle('collapsed');
    header.classList.toggle('collapsed');
  };
}
/* ================================================================ */

/* ======================== Wire UI ======================== */
$("bleConnectBtn").onclick = async ()=>{
  try { await bleConnect(); }
  catch(e) { 
    safeAlertBleError(e);
    cleanupBleState();
    $("bleConnectBtn").disabled = false;
  }
};

$("bleDisconnectBtn").onclick = ()=> bleDisconnect();

$("statusBtn").onclick = ()=> statusOnce().catch(e=> safeAlertBleError(e));
$("startPollBtn").onclick = ()=> startPoll();
$("stopPollBtn").onclick = ()=> stopPoll();

$("wifiScanBtn").onclick = ()=> wifiScan().catch(e=> safeAlertBleError(e));
$("wifiJoinBtn").onclick = ()=> wifiJoin().catch(e=> safeAlertBleError(e));
$("wifiStatusBtn").onclick = ()=> wifiStatus().catch(e=> safeAlertBleError(e));
$("wifiOffBtn").onclick = ()=> wifiOff().catch(e=> safeAlertBleError(e));

$("searchBox").addEventListener("input", onSearchInput);
$("searchBox").addEventListener("blur", onSearchBlur);
$("searchBox").addEventListener("focus", onSearchFocus);

$("saveCrateBtn").onclick = ()=> saveCrate();
$("refreshCratesBtn").onclick = ()=> refreshCrates();
$("clearSelectedBtn").onclick = ()=>{
  if (selected.length === 0) return;
  if (!confirm("Clear all tracks from current playlist?")) return;
  selected.length = 0;
  renderSelected();
  renderResults(lastSearchItems);
  showToast("Playlist cleared", 'info');
};
/* ================================================================ */

/* ======================== Boot ======================== */
setBleUi(false);
wifiRenderNets();
renderSelected();
refreshCrates();
setupCollapsible('bleAdvancedHeader', 'bleAdvancedContent');

(function boot() {
  $("searchHint").textContent = "Type to search tracks";
  
  // Add subtle entrance animations
  const cards = document.querySelectorAll('.card');
  cards.forEach((card, i) => {
    card.style.animationDelay = `${i * 0.1}s`;
  });
})();
</script>
</body>
</html>
