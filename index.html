<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DVS Crates (Bluefy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; background:#eee; }
    .good{ background:#d6ffe0; } .warn{ background:#fff2c9; } .bad{ background:#ffd6d6; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; gap:10px; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee; }
    button,input,select { padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; }
    button:disabled { opacity:0.5; }
    input[type="text"] { width:min(520px,100%); }
    small { opacity:0.7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .results .row { align-items:flex-start; }
    .muted { opacity: 0.75; }
  </style>
</head>
<body>
  <header>
    <h1>DVS Crates</h1>
    <div id="vinylPill" class="pill">VINYL: unknown</div>
  </header>

  <div class="grid">
    <section class="card">
      <h2>1) Connect to Raspberry Pi (BLE via Bluefy)</h2>
      <div class="row">
        <div><b>Bluetooth</b><br/><small>Requires HTTPS + Bluefy.</small></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="bleConnectBtn">Connect</button>
          <button id="bleDisconnectBtn" disabled>Disconnect</button>
        </div>
      </div>

      <div class="row">
        <div><b>Status</b><br/><small>Polls STATUS and updates VINYL pill.</small></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="statusBtn" disabled>STATUS</button>
          <button id="startPollBtn" disabled>Start Poll</button>
          <button id="stopPollBtn" disabled>Stop Poll</button>
        </div>
      </div>

      <div class="mono" id="bleLog" style="white-space:pre-wrap;"></div>
      <div class="muted"><small id="env"></small></div>
    </section>

    <section class="card">
      <h2>2) Spotify Login + Search (≤ 10 min)</h2>
      <div class="row">
        <div><b>Spotify</b><br/><small>Set Client ID + Redirect URI must match exactly.</small></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="spotifyLoginBtn">Login</button>
          <button id="spotifyLogoutBtn">Logout</button>
        </div>
      </div>
      <div id="me" class="muted"></div>

      <div class="row">
        <input id="searchBox" type="text" placeholder="Search tracks…" />
        <button id="searchBtn">Search</button>
      </div>

      <div class="results" id="results"></div>
    </section>
  </div>

  <section class="card">
    <h2>3) Upload audio files to Pi (WAV/MP3 from phone)</h2>
    <div class="row">
      <div><b>Choose files</b><br/><small>Uploads via UPLOAD_BEGIN name size + raw bytes.</small></div>
      <input id="filePicker" type="file" multiple />
    </div>
    <div class="row">
      <div id="uploadProgress" class="muted"></div>
      <div><button id="uploadBtn" disabled>Upload</button></div>
    </div>
  </section>

  <section class="card">
    <h2>4) Library on Pi (LIST / PLAY / STOP / DELETE)</h2>
    <div class="row">
      <div><b>Pi tracks</b><br/><small>Uses dvs_core commands via BLE bridge.</small></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="listBtn" disabled>LIST</button>
        <button id="stopBtn" disabled>STOP</button>
      </div>
    </div>

    <div class="row">
      <select id="piTrackSelect" style="width:min(520px,100%);" disabled></select>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="playBtn" disabled>PLAY</button>
        <button id="deleteBtn" disabled>DELETE</button>
      </div>
    </div>

    <div class="mono" id="piListBox" style="white-space:pre-wrap;"></div>
  </section>

<script>
/* ======================== CHANGE ME (Spotify) ======================== */
const SPOTIFY_CLIENT_ID = "CHANGE_ME_SPOTIFY_CLIENT_ID";
const REDIRECT_URI = location.origin + location.pathname;
const SCOPES = ["user-read-email"];
const MAX_MS = 10 * 60 * 1000;
/* ================================================================ */

/* ======================== BLE Nordic UART UUIDs ======================== */
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write
const UART_TX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify
/* ================================================================ */

const $ = (id) => document.getElementById(id);

function logBle(msg) { $("bleLog").textContent = msg + "\n" + $("bleLog").textContent; }
function setVinylPill({ ready, lock }) {
  const pill = $("vinylPill");
  if (ready) { pill.className="pill good"; pill.textContent="VINYL: READY"; }
  else if (lock) { pill.className="pill warn"; pill.textContent="VINYL: LOCKED"; }
  else { pill.className="pill bad"; pill.textContent="VINYL: NO LOCK"; }
}
function enc(str){ return new TextEncoder().encode(str); }

let ble = {
  device:null, server:null, rx:null, tx:null,
  connected:false,
  notifyBuf:"",
  lastStatus:{ready:false, lock:false, posMs:0, rate:1.0},
  pollTimer:null,
};

function setBleUi(connected) {
  $("bleConnectBtn").disabled = connected;
  $("bleDisconnectBtn").disabled = !connected;
  $("statusBtn").disabled = !connected;
  $("startPollBtn").disabled = !connected;
  $("stopPollBtn").disabled = !connected;
  $("uploadBtn").disabled = !connected;
  $("listBtn").disabled = !connected;
  $("playBtn").disabled = !connected;
  $("stopBtn").disabled = !connected;
  $("deleteBtn").disabled = !connected;
  $("piTrackSelect").disabled = !connected;
}

async function bleWriteLine(line) {
  if (!ble.connected) throw new Error("BLE not connected");
  if (!line.endsWith("\n")) line += "\n";
  const data = enc(line);
  if (ble.rx.writeValueWithoutResponse) await ble.rx.writeValueWithoutResponse(data);
  else await ble.rx.writeValue(data);
}

async function bleWriteBytes(u8) {
  if (!ble.connected) throw new Error("BLE not connected");
  if (ble.rx.writeValueWithoutResponse) await ble.rx.writeValueWithoutResponse(u8);
  else await ble.rx.writeValue(u8);
}

function onBleText(text) {
  ble.notifyBuf += text;
  let idx;
  while ((idx = ble.notifyBuf.indexOf("\n")) >= 0) {
    const line = ble.notifyBuf.slice(0, idx).trim();
    ble.notifyBuf = ble.notifyBuf.slice(idx + 1);
    if (!line) continue;

    if (line.startsWith("READY ")) ble.lastStatus.ready = line.endsWith("1");
    else if (line.startsWith("LOCK ")) ble.lastStatus.lock = line.endsWith("1");
    else if (line.startsWith("POS_MS ")) ble.lastStatus.posMs = parseInt(line.slice(7), 10) || 0;
    else if (line.startsWith("RATE ")) ble.lastStatus.rate = parseFloat(line.slice(5)) || 0;
    else if (line === ".") setVinylPill({ ready: ble.lastStatus.ready, lock: ble.lastStatus.lock });

    logBle(line);
  }
}

async function bleConnect() {
  // Helpful environment info
  const secure = window.isSecureContext;
  if (!secure) alert("Not a secure context. You MUST serve this page over HTTPS for Web Bluetooth.");
  if (!navigator.bluetooth) alert("navigator.bluetooth not available. Use Bluefy on iOS and HTTPS.");

  ble.device = await navigator.bluetooth.requestDevice({
    filters: [{ services: [UART_SERVICE_UUID] }],
  });

  ble.server = await ble.device.gatt.connect();
  const svc = await ble.server.getPrimaryService(UART_SERVICE_UUID);
  ble.rx = await svc.getCharacteristic(UART_RX_UUID);
  ble.tx = await svc.getCharacteristic(UART_TX_UUID);

  await ble.tx.startNotifications();
  ble.tx.addEventListener("characteristicvaluechanged", (ev) => {
    const v = ev.target.value;
    const bytes = new Uint8Array(v.buffer);
    onBleText(new TextDecoder().decode(bytes));
  });

  ble.connected = true;
  setBleUi(true);
  logBle("BLE connected. Tap STATUS.");
}

async function bleDisconnect() {
  stopPoll();
  try { if (ble.device?.gatt?.connected) ble.device.gatt.disconnect(); } catch {}
  ble.connected = false;
  setBleUi(false);
  logBle("BLE disconnected.");
}

async function statusOnce() { await bleWriteLine("STATUS"); }

function startPoll() {
  stopPoll();
  ble.pollTimer = setInterval(() => { if (ble.connected) bleWriteLine("STATUS").catch(()=>{}); }, 300);
  logBle("Polling STATUS…");
}
function stopPoll() {
  if (ble.pollTimer) clearInterval(ble.pollTimer);
  ble.pollTimer = null;
  logBle("Stopped polling.");
}

async function uploadFiles() {
  const files = [...$("filePicker").files];
  if (!files.length) return alert("Pick WAV/MP3 files first.");

  for (const f of files) {
    const safeName = f.name.replace(/\s+/g, "_");
    const buf = await f.arrayBuffer();
    const bytes = new Uint8Array(buf);

    $("uploadProgress").textContent = `Uploading ${safeName}…`;
    await bleWriteLine(`UPLOAD_BEGIN ${safeName} ${bytes.byteLength}`);

    // Chunk size tuned for iOS BLE stability
    const chunkSize = 180;
    let sent = 0;
    while (sent < bytes.byteLength) {
      const end = Math.min(sent + chunkSize, bytes.byteLength);
      await bleWriteBytes(bytes.slice(sent, end));
      sent = end;
      $("uploadProgress").textContent = `Uploading ${safeName}: ${Math.round((sent/bytes.byteLength)*100)}%`;
      await new Promise(r => setTimeout(r, 0));
    }
  }

  $("uploadProgress").textContent = "Uploads done.";
  await listPi();
}

async function listPi() {
  $("piListBox").textContent = "";
  $("piTrackSelect").innerHTML = "";
  await bleWriteLine("LIST");

  // Best-effort parse the most recent block from the log:
  setTimeout(() => {
    const lines = $("bleLog").textContent.split("\n").map(s => s.trim()).filter(Boolean);
    const end = lines.indexOf("."); // because we prepend log, most recent "." is near top
    if (end < 0) return;

    const block = lines.slice(0, end)
      .filter(s => !s.startsWith("READY ") && !s.startsWith("LOCK ") && !s.startsWith("POS_MS ") && !s.startsWith("RATE "))
      .filter(s => s !== "LIST" && s !== "OK" && s !== "ERR");

    const names = [...new Set(block)].reverse();

    const sel = $("piTrackSelect");
    sel.innerHTML = "";
    for (const name of names) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }
    $("piListBox").textContent = names.length ? names.join("\n") : "(No tracks found — upload files first.)";
  }, 250);
}

async function playSelected() {
  const name = $("piTrackSelect").value;
  if (!name) return alert("No track selected.");
  await bleWriteLine(`PLAY ${name}`);
  await statusOnce();
}
async function stopPlayback() { await bleWriteLine("STOP"); await statusOnce(); }
async function deleteSelected() {
  const name = $("piTrackSelect").value;
  if (!name) return alert("No track selected.");
  if (!confirm(`Delete ${name}?`)) return;
  await bleWriteLine(`DELETE ${name}`);
  await listPi();
  await statusOnce();
}

/* ======================== Spotify PKCE ======================== */
function base64urlencode(a) {
  return btoa(String.fromCharCode(...new Uint8Array(a)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}
async function sha256(plain) { return crypto.subtle.digest("SHA-256", new TextEncoder().encode(plain)); }
function randomString(len = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let s = "";
  for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}
function spotifyToken(){ return localStorage.getItem("spotify_token"); }

async function spotifyLogin() {
  if (SPOTIFY_CLIENT_ID.includes("CHANGE_ME")) {
    alert("Set SPOTIFY_CLIENT_ID in the HTML first.");
    return;
  }
  const verifier = randomString(96);
  const challenge = base64urlencode(await sha256(verifier));
  localStorage.setItem("pkce_verifier", verifier);

  const args = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID,
    response_type: "code",
    redirect_uri: REDIRECT_URI,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: SCOPES.join(" "),
  });

  location.href = `https://accounts.spotify.com/authorize?${args.toString()}`;
}

async function exchangeCodeForToken(code) {
  const verifier = localStorage.getItem("pkce_verifier");
  const body = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID,
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier,
  });

  const r = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  });
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  localStorage.setItem("spotify_token", data.access_token);
  history.replaceState({}, document.title, REDIRECT_URI);
  return data.access_token;
}

function spotifyLogout() {
  localStorage.removeItem("spotify_token");
  $("me").textContent = "";
  $("results").innerHTML = "";
  alert("Logged out.");
}

async function spotifyGET(path) {
  const token = spotifyToken();
  if (!token) throw new Error("Not logged in");
  const r = await fetch(`https://api.spotify.com/v1${path}`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  const data = await r.json();
  if (!r.ok) throw new Error(JSON.stringify(data));
  return data;
}

async function loadMe() {
  const me = await spotifyGET("/me");
  $("me").textContent = `Logged in as: ${me.display_name || me.id}`;
}

function renderResults(items) {
  const root = $("results");
  root.innerHTML = "";
  for (const t of items) {
    const tooLong = t.duration_ms > MAX_MS;
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div style="max-width: 70%;">
        <b>${t.name}</b> — ${t.artist}<br/>
        <small>${Math.round(t.duration_ms/1000)}s ${tooLong ? "(too long)" : ""}</small>
      </div>
      <div><button ${tooLong ? "disabled" : ""} data-uri="${t.uri}">Add</button></div>
    `;
    div.querySelector("button").onclick = () => alert("Crate builder omitted in this debug version (we can add it back once login works).");
    root.appendChild(div);
  }
}

async function doSearch() {
  if (!spotifyToken()) return alert("Login to Spotify first.");
  const q = $("searchBox").value.trim();
  if (!q) return;
  const data = await spotifyGET(`/search?type=track&limit=20&q=${encodeURIComponent(q)}`);
  const items = data.tracks.items.map(tr => ({
    id: tr.id, uri: tr.uri, name: tr.name,
    artist: tr.artists?.[0]?.name ?? "Unknown",
    duration_ms: tr.duration_ms,
  }));
  renderResults(items);
}
/* ================================================================ */

// Wire UI
$("bleConnectBtn").onclick = () => bleConnect().catch(e => alert("BLE connect error: " + e));
$("bleDisconnectBtn").onclick = () => bleDisconnect();
$("statusBtn").onclick = () => statusOnce().catch(e => alert("STATUS error: " + e));
$("startPollBtn").onclick = () => startPoll();
$("stopPollBtn").onclick = () => stopPoll();
$("uploadBtn").onclick = () => uploadFiles().catch(e => alert("Upload error: " + e));
$("listBtn").onclick = () => listPi().catch(e => alert("LIST error: " + e));
$("playBtn").onclick = () => playSelected().catch(e => alert("PLAY error: " + e));
$("stopBtn").onclick = () => stopPlayback().catch(e => alert("STOP error: " + e));
$("deleteBtn").onclick = () => deleteSelected().catch(e => alert("DELETE error: " + e));

$("spotifyLoginBtn").onclick = () => spotifyLogin().catch(e => alert("Spotify login error: " + e));
$("spotifyLogoutBtn").onclick = () => spotifyLogout();
$("searchBtn").onclick = () => doSearch().catch(e => alert("Search error: " + e));

setBleUi(false);

// Boot: handle Spotify redirect
(async function boot(){
  $("env").textContent =
    `secureContext=${window.isSecureContext} | navigator.bluetooth=${!!navigator.bluetooth} | URL=${REDIRECT_URI}`;
  const url = new URL(location.href);
  const code = url.searchParams.get("code");
  if (code) {
    try { await exchangeCodeForToken(code); }
    catch(e){ alert("Spotify token exchange failed. Check Redirect URI + Client ID.\n" + e); }
  }
  if (spotifyToken()) {
    try { await loadMe(); } catch {}
  }
})();
</script>
</body>
</html>
